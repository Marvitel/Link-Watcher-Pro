e.onuId)}return r=r.replace(/\{serial\}/g,e.onuSearchString||""),r=r.replace(/\{slot\}/g,e.slotOlt?.toString()||""),r=r.replace(/\{port\}/g,e.portOlt?.toString()||""),r=r.replace(/\{onuId\}/g,n),r}function Rb(t,e){if(t.diagnosisKeyTemplate){let n=_Q(t.diagnosisKeyTemplate,e);if(n&&n.trim())return n}if((t.vendor||"").toLowerCase()==="datacom"){if(e.onuId){let n=e.onuId.match(/(\d+\/\d+\/\d+:\d+)/);if(n)return n[1].replace(":","/");if(/^\d+\/\d+\/\d+\/\d+$/.test(e.onuId))return e.onuId}if(e.slotOlt!=null&&e.portOlt!=null&&e.onuId){let n=e.onuId.match(/:(\d+)$/);if(n)return`1/${e.slotOlt}/${e.portOlt}/${n[1]}`;if(/^\d+$/.test(e.onuId))return`1/${e.slotOlt}/${e.portOlt}/${e.onuId}`}return console.log(`[OLT Diagnosis] Datacom: n\xE3o foi poss\xEDvel montar chave de diagn\xF3stico. onuId=${e.onuId}, slot=${e.slotOlt}, port=${e.portOlt}`),null}return e.onuSearchString?e.onuSearchString:e.onuId}function i2(t,e,r){if(t.searchOnuCommand){let i=t.searchOnuCommand;if(i=i.replace(/\{serial\}/g,e),r){let s="";if(r.onuId){let a=r.onuId.match(/:(\d+)$/);a?s=a[1]:/^\d+$/.test(r.onuId)&&(s=r.onuId)}i=i.replace(/\{slot\}/g,r.slotOlt?.toString()||""),i=i.replace(/\{port\}/g,r.portOlt?.toString()||""),i=i.replace(/\{onuId\}/g,s)}return i}let n=(t.vendor||"").toLowerCase();switch(n){case"datacom":return`show interface gpon onu | include "${e}"`;case"furukawa":return`sh onu serial ${e}`;case"huawei":return`display ont info by-sn ${e}`;case"zte":return`show gpon onu by sn ${e}`;case"nokia":return`show equipment ont interface | match ${e}`;default:return console.log(`[OLT Search] Vendor ${n} n\xE3o tem comando de busca configurado`),null}}async function EQ(t,e){console.log(`[OLT Zabbix] Consultando MySQL ${t.ipAddress}:${t.port} por serial ${e}...`);try{console.log("[OLT Zabbix] Conectando ao MySQL...");let r=await xd.default.createConnection({host:t.ipAddress,port:t.port,user:t.username,password:t.password,database:t.database||"db_django_olts",connectTimeout:3e4});console.log("[OLT Zabbix] Conex\xE3o estabelecida com sucesso");let n=`
0|link-monitor  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
0|link-monitor  | Error: DATABASE_URL must be set. Did you forget to provision a database?
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:92:31605
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:1:225
0|link-monitor  |     at Object.<anonymous> (/opt/link-monitor/dist/index.cjs:228:273)
0|link-monitor  |     at Module._compile (node:internal/modules/cjs/loader:1521:14)
0|link-monitor  |     at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
0|link-monitor  |     at Module.load (node:internal/modules/cjs/loader:1266:32)
0|link-monitor  |     at Module._load (node:internal/modules/cjs/loader:1091:12)
0|link-monitor  |     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
0|link-monitor  |     at node:internal/main/run_main_module:28:49
0|link-monitor  | Node.js v20.19.6
0|link-monitor  | > rest-express@1.0.0 start
0|link-monitor  | > NODE_ENV=production node dist/index.cjs
0|link-monitor  | /opt/link-monitor/dist/index.cjs:92
0|link-monitor  | `);ll.write(CN.format.apply(CN,e))}}Object.defineProperty(ai.exports,"isWin",{get:function(){return md},set:function(t){md=t}});ai.exports.warnTo=function(t){var e=ll;return ll=t,e};ai.exports.getFileName=function(t){var e=t||process.env,r=e.PGPASSFILE||(md?AN.join(e.APPDATA||"./","postgresql","pgpass.conf"):AN.join(e.HOME||"./",".pgpass"));return r};ai.exports.usePgPass=function(t,e){return Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")?!1:md?!0:(e=e||"<unkn>",GW(t.mode)?t.mode&(UW|zW)?(yb('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',e),!1):!0:(yb('WARNING: password file "%s" is not a plain file',e),!1))};var QW=ai.exports.match=function(t,e){return eo.slice(0,-1).reduce(function(r,n,i){return i==1&&Number(t[n]||BW)===Number(e[n])?r&&!0:r&&(e[n]==="*"||e[n]===t[n])},!0)};ai.exports.getPassword=function(t,e,r){var n,i=e.pipe(FW());function s(l){var c=KW(l);c&&ZW(c)&&QW(t,c)&&(n=c[WW],i.end())}var a=function(){e.destroy(),r(n)},o=function(l){e.destroy(),yb("WARNING: error on reading file: %s",l),r(void 0)};e.on("error",o),i.on("data",s).on("end",a).on("error",o)};var KW=ai.exports.parseLine=function(t){if(t.length<11||t.match(/^\s+#/))return null;for(var e="",r="",n=0,i=0,s=0,a={},o=!1,l=function(u,p,d){var f=t.substring(p,d);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(f=f.replace(/\\([:\\])/g,"$1")),a[eo[u]]=f},c=0;c<t.length-1;c+=1){if(e=t.charAt(c+1),r=t.charAt(c),o=n==vb-1,o){l(n,i);break}c>=0&&e==":"&&r!=="\\"&&(l(n,i,c+1),i=c+2,n+=1)}return a=Object.keys(a).length===vb?a:null,a},ZW=ai.exports.isValidEntry=function(t){for(var e={0:function(a){return a.length>0},1:function(a){return a==="*"?!0:(a=Number(a),isFinite(a)&&a>0&&a<9007199254740992&&Math.floor(a)===a)},2:function(a){return a.length>0},3:function(a){return a.length>0},4:function(a){return a.length>0}},r=0;r<eo.length;r+=1){var n=e[r],i=t[eo[r]]||"",s=n(i);if(!s)return!1}return!0}});var ON=y((Uhe,bb)=>{"use strict";var Bhe=require("path"),PN=require("fs"),hd=TN();bb.exports=function(t,e){var r=hd.getFileName();PN.stat(r,function(n,i){if(n||!hd.usePgPass(i,r))return e(void 0);var s=PN.createReadStream(r);hd.getPassword(t,s,e)})};bb.exports.warnTo=hd.warnTo});var DN=y((zhe,RN)=>{"use strict";var XW=require("events").EventEmitter,NN=Ka(),xb=JO(),JW=od(),YW=U0(),LN=pN(),eQ=ol(),tQ=gb(),rQ=q0(),gd=class extends XW{constructor(e){super(),this.connectionParameters=new YW(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;let r=e||{};this._Promise=r.Promise||global.Promise,this._types=new JW(r.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.enableChannelBinding=!!r.enableChannelBinding,this.connection=r.connection||new tQ({stream:r.stream,ssl:this.connectionParameters.ssl,keepAlive:r.keepAlive||!1,keepAliveInitialDelayMillis:r.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=r.binary||eQ.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=r.connectionTimeoutMillis||0}_errorAllQueries(e){let r=n=>{process.nextTick(()=>{n.handleError(e,this.connection)})};this.activeQuery&&(r(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(r),this.queryQueue.length=0}_connect(e){let r=this,n=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let i=new Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(i)});return}this._connecting=!0,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{n._ending=!0,n.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis),this.connectionTimeoutHandle.unref&&this.connectionTimeoutHandle.unref()),this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){r.ssl?n.requestSsl():n.startup(r.getStartupConf())}),n.on("sslconnect",function(){n.startup(r.getStartupConf())}),this._attachListeners(n),n.once("end",()=>{let i=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(i),this._ended=!0,this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(i):this._handleErrorEvent(i):this._connectionError||this._handleErrorEvent(i)),process.nextTick(()=>{this.emit("end")})})}connect(e){if(e){this._connect(e);return}return new this._Promise((r,n)=>{this._connect(i=>{i?n(i):r()})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let r=this.connection;if(typeof this.password=="function")this._Promise.resolve().then(()=>this.password()).then(n=>{if(n!==void 0){if(typeof n!="string"){r.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=n}else this.connectionParameters.password=this.password=null;e()}).catch(n=>{r.emit("error",n)});else if(this.password!==null)e();else try{ON()(this.connectionParameters,i=>{i!==void 0&&(this.connectionParameters.password=this.password=i),e()})}catch(n){this.emit("error",n)}}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(async()=>{try{let r=await rQ.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(r)}catch(r){this.emit("error",r)}})}_handleAuthSASL(e){this._checkPgPass(()=>{try{this.saslSession=xb.startSession(e.mechanisms,this.enableChannelBinding&&this.connection.stream),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(r){this.connection.emit("error",r)}})}async _handleAuthSASLContinue(e){try{await xb.continueSession(this.saslSession,this.password,e.data,this.enableChannelBinding&&this.connection.stream),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(r){this.connection.emit("error",r)}}_handleAuthSASLFinal(e){try{xb.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(r){this.connection.emit("error",r)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:r}=this;this.activeQuery=null,this.readyForQuery=!0,r&&r.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let r=this.activeQuery;if(!r){this._handleErrorEvent(e);return}this.activeQuery=null,r.handleError(e,this.connection)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){if(this.activeQuery==null){let r=new Error("Received unexpected commandComplete message from backend.");this._handleErrorEvent(r);return}this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(){if(this.activeQuery==null){let e=new Error("Received unexpected parseComplete message from backend.");this._handleErrorEvent(e);return}this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){let e=this.connectionParameters,r={user:e.user,database:e.database},n=e.application_name||e.fallback_application_name;return n&&(r.application_name=n),e.replication&&(r.replication=""+e.replication),e.statement_timeout&&(r.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(r.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(r.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(r.options=e.options),r}cancel(e,r){if(e.activeQuery===r){let n=this.connection;this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){n.cancel(e.processID,e.secretKey)})}else e.queryQueue.indexOf(r)!==-1&&e.queryQueue.splice(e.queryQueue.indexOf(r),1)}setTypeParser(e,r,n){return this._types.setTypeParser(e,r,n)}getTypeParser(e,r){return this._types.getTypeParser(e,r)}escapeIdentifier(e){return NN.escapeIdentifier(e)}escapeLiteral(e){return NN.escapeLiteral(e)}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&process.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,r,n){let i,s,a,o,l;if(e==null)throw new TypeError("Client was passed a null or undefined query");return typeof e.submit=="function"?(a=e.query_timeout||this.connectionParameters.query_timeout,s=i=e,typeof r=="function"&&(i.callback=i.callback||r)):(a=e.query_timeout||this.connectionParameters.query_timeout,i=new LN(e,r,n),i.callback||(s=new this._Promise((c,u)=>{i.callback=(p,d)=>p?u(p):c(d)}).catch(c=>{throw Error.captureStackTrace(c),c}))),a&&(l=i.callback,o=setTimeout(()=>{let c=new Error("Query read timeout");process.nextTick(()=>{i.handleError(c,this.connection)}),l(c),i.callback=()=>{};let u=this.queryQueue.indexOf(i);u>-1&&this.queryQueue.splice(u,1),this._pulseQueryQueue()},a),i.callback=(c,u)=>{clearTimeout(o),l(c,u)}),this.binary&&!i.binary&&(i.binary=!0),i._result&&!i._result._types&&(i._result._types=this._types),this._queryable?this._ending?(process.nextTick(()=>{i.handleError(new Error("Client was closed and is not queryable"),this.connection)}),s):(this.queryQueue.push(i),this._pulseQueryQueue(),s):(process.nextTick(()=>{i.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),s)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(e)e();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),e)this.connection.once("end",e);else return new this._Promise(r=>{this.connection.once("end",r)})}};gd.Query=LN;RN.exports=gd});var qN=y((Vhe,MN)=>{"use strict";var nQ=require("events").EventEmitter,$N=function(){},jN=(t,e)=>{let r=t.findIndex(e);return r===-1?void 0:t.splice(r,1)[0]},wb=class{constructor(e,r,n){this.client=e,this.idleListener=r,this.timeoutId=n}},to=class{constructor(e){this.callback=e}};function iQ(){throw new Error("Release called on client which has already been released to the pool.")}function vd(t,e){if(e)return{callback:e,result:void 0};let r,n,i=function(a,o){a?r(a):n(o)},s=new t(function(a,o){n=a,r=o}).catch(a=>{throw Error.captureStackTrace(a),a});return{callback:i,result:s}}function sQ(t,e){return function r(n){n.client=e,e.removeListener("error",r),e.on("error",()=>{t.log("additional client error after disconnection due to error",n)}),t._remove(e),t.emit("error",n,e)}}var Sb=class extends nQ{constructor(e,r){super(),this.options=Object.assign({},e),e!=null&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),e!=null&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||r||_b().Client,this.Promise=this.options.Promise||global.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(r=>{this._remove(r.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let r=this._idle.pop();clearTimeout(r.timeoutId);let n=r.client;n.ref&&n.ref();let i=r.idleListener;return this._acquireClient(n,e,i,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e,r){let n=jN(this._idle,s=>s.client===e);n!==void 0&&clearTimeout(n.timeoutId),this._clients=this._clients.filter(s=>s!==e);let i=this;e.end(()=>{i.emit("remove",e),typeof r=="function"&&r()})}connect(e){if(this.ending){let i=new Error("Cannot use a pool after calling end on the pool");return e?e(i):this.Promise.reject(i)}let r=vd(this.Promise,e),n=r.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new to(r.callback)),n;let i=(o,l,c)=>{clearTimeout(a),r.callback(o,l,c)},s=new to(i),a=setTimeout(()=>{jN(this._pendingQueue,o=>o.callback===i),s.timedOut=!0,r.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return a.unref&&a.unref(),this._pendingQueue.push(s),n}return this.newClient(new to(r.callback)),n}newClient(e){let r=new this.Client(this.options);this._clients.push(r);let n=sQ(this,r);this.log("checking client timeout");let i,s=!1;this.options.connectionTimeoutMillis&&(i=setTimeout(()=>{this.log("ending client due to timeout"),s=!0,r.connection?r.connection.stream.destroy():r.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),r.connect(a=>{if(i&&clearTimeout(i),r.on("error",n),a)this.log("client failed to connect",a),this._clients=this._clients.filter(o=>o!==r),s&&(a=new Error("Connection terminated due to connection timeout",{cause:a})),this._pulseQueue(),e.timedOut||e.callback(a,void 0,$N);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let o=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(r),this._idle.findIndex(c=>c.client===r)!==-1&&this._acquireClient(r,new to((c,u,p)=>p()),n,!1)},this.options.maxLifetimeSeconds*1e3);o.unref(),r.once("end",()=>clearTimeout(o))}return this._acquireClient(r,e,n,!0)}})}_acquireClient(e,r,n,i){i&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,n),e.removeListener("error",n),r.timedOut?i&&this.options.verify?this.options.verify(e,e.release):e.release():i&&this.options.verify?this.options.verify(e,s=>{if(s)return e.release(s),r.callback(s,void 0,$N);r.callback(void 0,e,e.release)}):r.callback(void 0,e,e.release)}_releaseOnce(e,r){let n=!1;return i=>{n&&iQ(),n=!0,this._release(e,r,i)}}_release(e,r,n){if(e.on("error",r),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",n,e),n||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this));if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this));let s;this.options.idleTimeoutMillis&&this._isAboveMin()&&(s=setTimeout(()=>{this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&s.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new wb(e,r,s)),this._pulseQueue()}query(e,r,n){if(typeof e=="function"){let s=vd(this.Promise,e);return setImmediate(function(){return s.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),s.result}typeof r=="function"&&(n=r,r=void 0);let i=vd(this.Promise,n);return n=i.callback,this.connect((s,a)=>{if(s)return n(s);let o=!1,l=c=>{o||(o=!0,a.release(c),n(c))};a.once("error",l),this.log("dispatching query");try{a.query(e,r,(c,u)=>{if(this.log("query dispatched"),a.removeListener("error",l),!o)return o=!0,a.release(c),c?n(c):n(void 0,u)})}catch(c){return a.release(c),n(c)}}),i.result}end(e){if(this.log("ending"),this.ending){let n=new Error("Called end on pool more than once");return e?e(n):this.Promise.reject(n)}this.ending=!0;let r=vd(this.Promise,e);return this._endCallback=r.callback,this._pulseQueue(),r.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,r)=>e+(this._expired.has(r)?1:0),0)}get totalCount(){return this._clients.length}};MN.exports=Sb});var UN=y((Hhe,BN)=>{"use strict";var FN=require("events").EventEmitter,aQ=require("util"),Eb=Ka(),ro=BN.exports=function(t,e,r){FN.call(this),t=Eb.normalizeQueryConfig(t,e,r),this.text=t.text,this.values=t.values,this.name=t.name,this.queryMode=t.queryMode,this.callback=t.callback,this.state="new",this._arrayMode=t.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(n){n==="row"&&(this._emitRowEvents=!0)}.bind(this))};aQ.inherits(ro,FN);var oQ={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};ro.prototype.handleError=function(t){let e=this.native.pq.resultErrorFields();if(e)for(let r in e){let n=oQ[r]||r;t[n]=e[r]}this.callback?this.callback(t):this.emit("error",t),this.state="error"};ro.prototype.then=function(t,e){return this._getPromise().then(t,e)};ro.prototype.catch=function(t){return this._getPromise().catch(t)};ro.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(t,e){this._once("end",t),this._once("error",e)}.bind(this)),this._promise)};ro.prototype.submit=function(t){this.state="running";let e=this;this.native=t.native,t.native.arrayMode=this._arrayMode;let r=function(n,i,s){if(t.native.arrayMode=!1,setImmediate(function(){e.emit("_done")}),n)return e.handleError(n);e._emitRowEvents&&(s.length>1?i.forEach((a,o)=>{a.forEach(l=>{e.emit("row",l,s[o])})}):i.forEach(function(a){e.emit("row",a,s)})),e.state="end",e.emit("end",s),e.callback&&e.callback(null,s)};if(process.domain&&(r=process.domain.bind(r)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));let n=(this.values||[]).map(Eb.prepareValue);if(t.namedQueries[this.name]){if(this.text&&t.namedQueries[this.name]!==this.text){let i=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return r(i)}return t.native.execute(this.name,n,r)}return t.native.prepare(this.name,this.text,n.length,function(i){return i?r(i):(t.namedQueries[e.name]=e.text,e.native.execute(e.name,n,r))})}else if(this.values){if(!Array.isArray(this.values)){let i=new Error("Query values must be an array");return r(i)}let n=this.values.map(Eb.prepareValue);t.native.query(this.text,n,r)}else this.queryMode==="extended"?t.native.query(this.text,[],r):t.native.query(this.text,r)}});var WN=y((Ghe,GN)=>{"use strict";var zN;try{zN=require("pg-native")}catch(t){throw t}var cQ=od(),VN=require("events").EventEmitter,lQ=require("util"),uQ=U0(),HN=UN(),Ir=GN.exports=function(t){VN.call(this),t=t||{},this._Promise=t.Promise||global.Promise,this._types=new cQ(t.types),this.native=new zN({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;let e=this.connectionParameters=new uQ(t);t.nativeConnectionString&&(e.nativeConnectionString=t.nativeConnectionString),this.user=e.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),this.database=e.database,this.host=e.host,this.port=e.port,this.namedQueries={}};Ir.Query=HN;lQ.inherits(Ir,VN);Ir.prototype._errorAllQueries=function(t){let e=r=>{process.nextTick(()=>{r.native=this.native,r.handleError(t)})};this._hasActiveQuery()&&(e(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(e),this._queryQueue.length=0};Ir.prototype._connect=function(t){let e=this;if(this._connecting){process.nextTick(()=>t(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(r,n){if(e.connectionParameters.nativeConnectionString&&(n=e.connectionParameters.nativeConnectionString),r)return t(r);e.native.connect(n,function(i){if(i)return e.native.end(),t(i);e._connected=!0,e.native.on("error",function(s){e._queryable=!1,e._errorAllQueries(s),e.emit("error",s)}),e.native.on("notification",function(s){e.emit("notification",{channel:s.relname,payload:s.extra})}),e.emit("connect"),e._pulseQueryQueue(!0),t()})})};Ir.prototype.connect=function(t){if(t){this._connect(t);return}return new this._Promise((e,r)=>{this._connect(n=>{n?r(n):e()})})};Ir.prototype.query=function(t,e,r){let n,i,s,a,o;if(t==null)throw new TypeError("Client was passed a null or undefined query");if(typeof t.submit=="function")s=t.query_timeout||this.connectionParameters.query_timeout,i=n=t,typeof e=="function"&&(t.callback=e);else if(s=t.query_timeout||this.connectionParameters.query_timeout,n=new HN(t,e,r),!n.callback){let l,c;i=new this._Promise((u,p)=>{l=u,c=p}).catch(u=>{throw Error.captureStackTrace(u),u}),n.callback=(u,p)=>u?c(u):l(p)}return s&&(o=n.callback,a=setTimeout(()=>{let l=new Error("Query read timeout");process.nextTick(()=>{n.handleError(l,this.connection)}),o(l),n.callback=()=>{};let c=this._queryQueue.indexOf(n);c>-1&&this._queryQueue.splice(c,1),this._pulseQueryQueue()},s),n.callback=(l,c)=>{clearTimeout(a),o(l,c)}),this._queryable?this._ending?(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client was closed and is not queryable"))}),i):(this._queryQueue.push(n),this._pulseQueryQueue(),i):(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client has encountered a connection error and is not queryable"))}),i)};Ir.prototype.end=function(t){let e=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,t));let r;return t||(r=new this._Promise(function(n,i){t=s=>s?i(s):n()})),this.native.end(function(){e._errorAllQueries(new Error("Connection terminated")),process.nextTick(()=>{e.emit("end"),t&&t()})}),r};Ir.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"};Ir.prototype._pulseQueryQueue=function(t){if(!this._connected||this._hasActiveQuery())return;let e=this._queryQueue.shift();if(!e){t||this.emit("drain");return}this._activeQuery=e,e.submit(this);let r=this;e.once("_done",function(){r._pulseQueryQueue()})};Ir.prototype.cancel=function(t){this._activeQuery===t?this.native.cancel(function(){}):this._queryQueue.indexOf(t)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(t),1)};Ir.prototype.ref=function(){};Ir.prototype.unref=function(){};Ir.prototype.setTypeParser=function(t,e,r){return this._types.setTypeParser(t,e,r)};Ir.prototype.getTypeParser=function(t,e){return this._types.getTypeParser(t,e)}});var Ib=y((Whe,QN)=>{"use strict";QN.exports=WN()});var _b=y((Khe,ul)=>{"use strict";var pQ=DN(),dQ=ol(),fQ=gb(),mQ=V0(),hQ=Ka(),gQ=qN(),vQ=od(),{DatabaseError:yQ}=fb(),{escapeIdentifier:bQ,escapeLiteral:xQ}=Ka(),wQ=t=>class extends gQ{constructor(r){super(r,t)}},kb=function(t){this.defaults=dQ,this.Client=t,this.Query=this.Client.Query,this.Pool=wQ(this.Client),this._pools=[],this.Connection=fQ,this.types=al(),this.DatabaseError=yQ,this.TypeOverrides=vQ,this.escapeIdentifier=bQ,this.escapeLiteral=xQ,this.Result=mQ,this.utils=hQ};typeof process.env.NODE_PG_FORCE_NATIVE<"u"?ul.exports=new kb(Ib()):(ul.exports=new kb(pQ),Object.defineProperty(ul.exports,"native",{configurable:!0,enumerable:!1,get(){let t=null;try{t=new kb(Ib())}catch(e){if(e.code!=="MODULE_NOT_FOUND")throw e}return Object.defineProperty(ul.exports,"native",{value:t}),t}}))});var Lr,Zhe,Xhe,Jhe,Yhe,ege,tge,rge,nge,ige,sge,age,dn,pl=L(()=>{Lr=ae(_b(),1),Zhe=Lr.default.Client,Xhe=Lr.default.Pool,Jhe=Lr.default.Connection,Yhe=Lr.default.types,ege=Lr.default.Query,tge=Lr.default.DatabaseError,rge=Lr.default.escapeIdentifier,nge=Lr.default.escapeLiteral,ige=Lr.default.Result,sge=Lr.default.TypeOverrides,age=Lr.default.defaults,dn=Lr.default});var KN,Ln,Ab,yd,Cb,Tb=L(()=>{pl();B();Kp();e0();Yy();ht();Vn();Le();({Pool:KN,types:Ln}=dn),Ab=class extends Vp{constructor(e,r,n,i,s,a,o,l){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=s,this._isResponseInArrayMode=o,this.customResultMapper=l,this.rawQueryConfig={name:a,text:r,types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}},this.queryConfig={name:a,text:r,rowMode:"array",types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}}}static[_]="NodePgPreparedQuery";rawQueryConfig;queryConfig;async execute(e={}){return Me.startActiveSpan("drizzle.execute",async()=>{let r=$g(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:s,queryConfig:a,joinsNotNullableMap:o,customResultMapper:l}=this;if(!n&&!l)return Me.startActiveSpan("drizzle.driver.execute",async u=>(u?.setAttributes({"drizzle.query.name":i.name,"drizzle.query.text":i.text,"drizzle.query.params":JSON.stringify(r)}),s.query(i,r)));let c=await Me.startActiveSpan("drizzle.driver.execute",u=>(u?.setAttributes({"drizzle.query.name":a.name,"drizzle.query.text":a.text,"drizzle.query.params":JSON.stringify(r)}),s.query(a,r)));return Me.startActiveSpan("drizzle.mapResponse",()=>l?l(c.rows):c.rows.map(u=>mT(n,u,o)))})}all(e={}){return Me.startActiveSpan("drizzle.execute",()=>{let r=$g(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),Me.startActiveSpan("drizzle.driver.execute",n=>(n?.setAttributes({"drizzle.query.name":this.rawQueryConfig.name,"drizzle.query.text":this.rawQueryConfig.text,"drizzle.query.params":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},yd=class t extends Hp{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new Qp}static[_]="NodePgSession";logger;prepareQuery(e,r,n,i,s){return new Ab(this.client,e.sql,e.params,this.logger,r,n,i,s)}async transaction(e,r){let n=this.client instanceof KN?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new Cb(this.dialect,n,this.schema);await i.execute(S`begin${r?S` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let s=await e(i);return await i.execute(S`commit`),s}catch(s){throw await i.execute(S`rollback`),s}finally{this.client instanceof KN&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},Cb=class t extends Gp{static[_]="NodePgTransaction";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(S.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(S.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(S.raw(`rollback to savepoint ${r}`)),i}}}});function dl(t,e={}){let r=new Oi({casing:e.casing}),n;e.logger===!0?n=new Wp:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let l=dP(e.schema,mP);i={fullSchema:e.schema,schema:l.tables,tableNamesMap:l.tableNamesMap}}let a=new Pb(t,r,{logger:n}).createSession(i),o=new Ob(r,a,i);return o.$client=t,o}function bd(...t){if(typeof t[0]=="string"){let e=new dn.Pool({connectionString:t[0]});return dl(e,t[1])}if(vT(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return dl(r,n);let i=typeof e=="string"?new dn.Pool({connectionString:e}):new dn.Pool(e);return dl(i,n)}return dl(t[0],t[1])}var Pb,Ob,ZN=L(()=>{pl();B();Kp();Bp();Op();Vc();Le();Tb();Pb=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[_]="NodePgDriver";createSession(e){return new yd(this.client,this.dialect,e,{logger:this.options.logger})}},Ob=class extends Da{static[_]="NodePgDatabase"};(t=>{function e(r){return dl({},r)}t.mock=e})(bd||(bd={}))});var XN=L(()=>{ZN();Tb()});var YN={};Mn(YN,{db:()=>g,pool:()=>JN});var SQ,JN,g,Os=L(()=>{"use strict";XN();pl();Ga();({Pool:SQ}=dn);if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");JN=new SQ({connectionString:process.env.DATABASE_URL}),g=bd(JN,{schema:_0})});var wd={};Mn(wd,{OLT_VENDORS:()=>LQ,buildOnuDiagnosisKey:()=>Rb,buildOnuSearchCommand:()=>i2,getDiagnosisFromAlarms:()=>FQ,hasSpecificDiagnosisCommand:()=>RQ,queryAllOltAlarms:()=>AQ,queryOltAlarm:()=>Ls,queryZabbixOpticalMetrics:()=>gl,searchOnuBySerial:()=>BQ,testOltConnection:()=>$b});function _Q(t,e){let r=t,n="";if(e.onuId){let i=e.onuId.match(/:(\d+)$/);i?n=i[1]:/^\d+$/.test(e.onuId)&&(n=e.onuId)}return r=r.replace(/\{serial\}/g,e.onuSearchString||""),r=r.replace(/\{slot\}/g,e.slotOlt?.toString()||""),r=r.replace(/\{port\}/g,e.portOlt?.toString()||""),r=r.replace(/\{onuId\}/g,n),r}function Rb(t,e){if(t.diagnosisKeyTemplate){let n=_Q(t.diagnosisKeyTemplate,e);if(n&&n.trim())return n}if((t.vendor||"").toLowerCase()==="datacom"){if(e.onuId){let n=e.onuId.match(/(\d+\/\d+\/\d+:\d+)/);if(n)return n[1].replace(":","/");if(/^\d+\/\d+\/\d+\/\d+$/.test(e.onuId))return e.onuId}if(e.slotOlt!=null&&e.portOlt!=null&&e.onuId){let n=e.onuId.match(/:(\d+)$/);if(n)return`1/${e.slotOlt}/${e.portOlt}/${n[1]}`;if(/^\d+$/.test(e.onuId))return`1/${e.slotOlt}/${e.portOlt}/${e.onuId}`}return console.log(`[OLT Diagnosis] Datacom: n\xE3o foi poss\xEDvel montar chave de diagn\xF3stico. onuId=${e.onuId}, slot=${e.slotOlt}, port=${e.portOlt}`),null}return e.onuSearchString?e.onuSearchString:e.onuId}function i2(t,e,r){if(t.searchOnuCommand){let i=t.searchOnuCommand;if(i=i.replace(/\{serial\}/g,e),r){let s="";if(r.onuId){let a=r.onuId.match(/:(\d+)$/);a?s=a[1]:/^\d+$/.test(r.onuId)&&(s=r.onuId)}i=i.replace(/\{slot\}/g,r.slotOlt?.toString()||""),i=i.replace(/\{port\}/g,r.portOlt?.toString()||""),i=i.replace(/\{onuId\}/g,s)}return i}let n=(t.vendor||"").toLowerCase();switch(n){case"datacom":return`show interface gpon onu | include "${e}"`;case"furukawa":return`sh onu serial ${e}`;case"huawei":return`display ont info by-sn ${e}`;case"zte":return`show gpon onu by sn ${e}`;case"nokia":return`show equipment ont interface | match ${e}`;default:return console.log(`[OLT Search] Vendor ${n} n\xE3o tem comando de busca configurado`),null}}async function EQ(t,e){console.log(`[OLT Zabbix] Consultando MySQL ${t.ipAddress}:${t.port} por serial ${e}...`);try{console.log("[OLT Zabbix] Conectando ao MySQL...");let r=await xd.default.createConnection({host:t.ipAddress,port:t.port,user:t.username,password:t.password,database:t.database||"db_django_olts",connectTimeout:3e4});console.log("[OLT Zabbix] Conex\xE3o estabelecida com sucesso");let n=`
0|link-monitor  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
0|link-monitor  | Error: DATABASE_URL must be set. Did you forget to provision a database?
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:92:31605
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:1:225
0|link-monitor  |     at Object.<anonymous> (/opt/link-monitor/dist/index.cjs:228:273)
0|link-monitor  |     at Module._compile (node:internal/modules/cjs/loader:1521:14)
0|link-monitor  |     at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
0|link-monitor  |     at Module.load (node:internal/modules/cjs/loader:1266:32)
0|link-monitor  |     at Module._load (node:internal/modules/cjs/loader:1091:12)
0|link-monitor  |     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
0|link-monitor  |     at node:internal/main/run_main_module:28:49
0|link-monitor  | Node.js v20.19.6
0|link-monitor  | > rest-express@1.0.0 start
0|link-monitor  | > NODE_ENV=production node dist/index.cjs
0|link-monitor  | /opt/link-monitor/dist/index.cjs:92
0|link-monitor  | `);ll.write(CN.format.apply(CN,e))}}Object.defineProperty(ai.exports,"isWin",{get:function(){return md},set:function(t){md=t}});ai.exports.warnTo=function(t){var e=ll;return ll=t,e};ai.exports.getFileName=function(t){var e=t||process.env,r=e.PGPASSFILE||(md?AN.join(e.APPDATA||"./","postgresql","pgpass.conf"):AN.join(e.HOME||"./",".pgpass"));return r};ai.exports.usePgPass=function(t,e){return Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")?!1:md?!0:(e=e||"<unkn>",GW(t.mode)?t.mode&(UW|zW)?(yb('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',e),!1):!0:(yb('WARNING: password file "%s" is not a plain file',e),!1))};var QW=ai.exports.match=function(t,e){return eo.slice(0,-1).reduce(function(r,n,i){return i==1&&Number(t[n]||BW)===Number(e[n])?r&&!0:r&&(e[n]==="*"||e[n]===t[n])},!0)};ai.exports.getPassword=function(t,e,r){var n,i=e.pipe(FW());function s(l){var c=KW(l);c&&ZW(c)&&QW(t,c)&&(n=c[WW],i.end())}var a=function(){e.destroy(),r(n)},o=function(l){e.destroy(),yb("WARNING: error on reading file: %s",l),r(void 0)};e.on("error",o),i.on("data",s).on("end",a).on("error",o)};var KW=ai.exports.parseLine=function(t){if(t.length<11||t.match(/^\s+#/))return null;for(var e="",r="",n=0,i=0,s=0,a={},o=!1,l=function(u,p,d){var f=t.substring(p,d);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(f=f.replace(/\\([:\\])/g,"$1")),a[eo[u]]=f},c=0;c<t.length-1;c+=1){if(e=t.charAt(c+1),r=t.charAt(c),o=n==vb-1,o){l(n,i);break}c>=0&&e==":"&&r!=="\\"&&(l(n,i,c+1),i=c+2,n+=1)}return a=Object.keys(a).length===vb?a:null,a},ZW=ai.exports.isValidEntry=function(t){for(var e={0:function(a){return a.length>0},1:function(a){return a==="*"?!0:(a=Number(a),isFinite(a)&&a>0&&a<9007199254740992&&Math.floor(a)===a)},2:function(a){return a.length>0},3:function(a){return a.length>0},4:function(a){return a.length>0}},r=0;r<eo.length;r+=1){var n=e[r],i=t[eo[r]]||"",s=n(i);if(!s)return!1}return!0}});var ON=y((Uhe,bb)=>{"use strict";var Bhe=require("path"),PN=require("fs"),hd=TN();bb.exports=function(t,e){var r=hd.getFileName();PN.stat(r,function(n,i){if(n||!hd.usePgPass(i,r))return e(void 0);var s=PN.createReadStream(r);hd.getPassword(t,s,e)})};bb.exports.warnTo=hd.warnTo});var DN=y((zhe,RN)=>{"use strict";var XW=require("events").EventEmitter,NN=Ka(),xb=JO(),JW=od(),YW=U0(),LN=pN(),eQ=ol(),tQ=gb(),rQ=q0(),gd=class extends XW{constructor(e){super(),this.connectionParameters=new YW(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;let r=e||{};this._Promise=r.Promise||global.Promise,this._types=new JW(r.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.enableChannelBinding=!!r.enableChannelBinding,this.connection=r.connection||new tQ({stream:r.stream,ssl:this.connectionParameters.ssl,keepAlive:r.keepAlive||!1,keepAliveInitialDelayMillis:r.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=r.binary||eQ.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=r.connectionTimeoutMillis||0}_errorAllQueries(e){let r=n=>{process.nextTick(()=>{n.handleError(e,this.connection)})};this.activeQuery&&(r(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(r),this.queryQueue.length=0}_connect(e){let r=this,n=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let i=new Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(i)});return}this._connecting=!0,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{n._ending=!0,n.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis),this.connectionTimeoutHandle.unref&&this.connectionTimeoutHandle.unref()),this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){r.ssl?n.requestSsl():n.startup(r.getStartupConf())}),n.on("sslconnect",function(){n.startup(r.getStartupConf())}),this._attachListeners(n),n.once("end",()=>{let i=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(i),this._ended=!0,this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(i):this._handleErrorEvent(i):this._connectionError||this._handleErrorEvent(i)),process.nextTick(()=>{this.emit("end")})})}connect(e){if(e){this._connect(e);return}return new this._Promise((r,n)=>{this._connect(i=>{i?n(i):r()})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let r=this.connection;if(typeof this.password=="function")this._Promise.resolve().then(()=>this.password()).then(n=>{if(n!==void 0){if(typeof n!="string"){r.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=n}else this.connectionParameters.password=this.password=null;e()}).catch(n=>{r.emit("error",n)});else if(this.password!==null)e();else try{ON()(this.connectionParameters,i=>{i!==void 0&&(this.connectionParameters.password=this.password=i),e()})}catch(n){this.emit("error",n)}}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(async()=>{try{let r=await rQ.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(r)}catch(r){this.emit("error",r)}})}_handleAuthSASL(e){this._checkPgPass(()=>{try{this.saslSession=xb.startSession(e.mechanisms,this.enableChannelBinding&&this.connection.stream),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(r){this.connection.emit("error",r)}})}async _handleAuthSASLContinue(e){try{await xb.continueSession(this.saslSession,this.password,e.data,this.enableChannelBinding&&this.connection.stream),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(r){this.connection.emit("error",r)}}_handleAuthSASLFinal(e){try{xb.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(r){this.connection.emit("error",r)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:r}=this;this.activeQuery=null,this.readyForQuery=!0,r&&r.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let r=this.activeQuery;if(!r){this._handleErrorEvent(e);return}this.activeQuery=null,r.handleError(e,this.connection)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){if(this.activeQuery==null){let r=new Error("Received unexpected commandComplete message from backend.");this._handleErrorEvent(r);return}this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(){if(this.activeQuery==null){let e=new Error("Received unexpected parseComplete message from backend.");this._handleErrorEvent(e);return}this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){let e=this.connectionParameters,r={user:e.user,database:e.database},n=e.application_name||e.fallback_application_name;return n&&(r.application_name=n),e.replication&&(r.replication=""+e.replication),e.statement_timeout&&(r.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(r.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(r.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(r.options=e.options),r}cancel(e,r){if(e.activeQuery===r){let n=this.connection;this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){n.cancel(e.processID,e.secretKey)})}else e.queryQueue.indexOf(r)!==-1&&e.queryQueue.splice(e.queryQueue.indexOf(r),1)}setTypeParser(e,r,n){return this._types.setTypeParser(e,r,n)}getTypeParser(e,r){return this._types.getTypeParser(e,r)}escapeIdentifier(e){return NN.escapeIdentifier(e)}escapeLiteral(e){return NN.escapeLiteral(e)}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&process.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,r,n){let i,s,a,o,l;if(e==null)throw new TypeError("Client was passed a null or undefined query");return typeof e.submit=="function"?(a=e.query_timeout||this.connectionParameters.query_timeout,s=i=e,typeof r=="function"&&(i.callback=i.callback||r)):(a=e.query_timeout||this.connectionParameters.query_timeout,i=new LN(e,r,n),i.callback||(s=new this._Promise((c,u)=>{i.callback=(p,d)=>p?u(p):c(d)}).catch(c=>{throw Error.captureStackTrace(c),c}))),a&&(l=i.callback,o=setTimeout(()=>{let c=new Error("Query read timeout");process.nextTick(()=>{i.handleError(c,this.connection)}),l(c),i.callback=()=>{};let u=this.queryQueue.indexOf(i);u>-1&&this.queryQueue.splice(u,1),this._pulseQueryQueue()},a),i.callback=(c,u)=>{clearTimeout(o),l(c,u)}),this.binary&&!i.binary&&(i.binary=!0),i._result&&!i._result._types&&(i._result._types=this._types),this._queryable?this._ending?(process.nextTick(()=>{i.handleError(new Error("Client was closed and is not queryable"),this.connection)}),s):(this.queryQueue.push(i),this._pulseQueryQueue(),s):(process.nextTick(()=>{i.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),s)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(e)e();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),e)this.connection.once("end",e);else return new this._Promise(r=>{this.connection.once("end",r)})}};gd.Query=LN;RN.exports=gd});var qN=y((Vhe,MN)=>{"use strict";var nQ=require("events").EventEmitter,$N=function(){},jN=(t,e)=>{let r=t.findIndex(e);return r===-1?void 0:t.splice(r,1)[0]},wb=class{constructor(e,r,n){this.client=e,this.idleListener=r,this.timeoutId=n}},to=class{constructor(e){this.callback=e}};function iQ(){throw new Error("Release called on client which has already been released to the pool.")}function vd(t,e){if(e)return{callback:e,result:void 0};let r,n,i=function(a,o){a?r(a):n(o)},s=new t(function(a,o){n=a,r=o}).catch(a=>{throw Error.captureStackTrace(a),a});return{callback:i,result:s}}function sQ(t,e){return function r(n){n.client=e,e.removeListener("error",r),e.on("error",()=>{t.log("additional client error after disconnection due to error",n)}),t._remove(e),t.emit("error",n,e)}}var Sb=class extends nQ{constructor(e,r){super(),this.options=Object.assign({},e),e!=null&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),e!=null&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||r||_b().Client,this.Promise=this.options.Promise||global.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(r=>{this._remove(r.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let r=this._idle.pop();clearTimeout(r.timeoutId);let n=r.client;n.ref&&n.ref();let i=r.idleListener;return this._acquireClient(n,e,i,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e,r){let n=jN(this._idle,s=>s.client===e);n!==void 0&&clearTimeout(n.timeoutId),this._clients=this._clients.filter(s=>s!==e);let i=this;e.end(()=>{i.emit("remove",e),typeof r=="function"&&r()})}connect(e){if(this.ending){let i=new Error("Cannot use a pool after calling end on the pool");return e?e(i):this.Promise.reject(i)}let r=vd(this.Promise,e),n=r.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new to(r.callback)),n;let i=(o,l,c)=>{clearTimeout(a),r.callback(o,l,c)},s=new to(i),a=setTimeout(()=>{jN(this._pendingQueue,o=>o.callback===i),s.timedOut=!0,r.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return a.unref&&a.unref(),this._pendingQueue.push(s),n}return this.newClient(new to(r.callback)),n}newClient(e){let r=new this.Client(this.options);this._clients.push(r);let n=sQ(this,r);this.log("checking client timeout");let i,s=!1;this.options.connectionTimeoutMillis&&(i=setTimeout(()=>{this.log("ending client due to timeout"),s=!0,r.connection?r.connection.stream.destroy():r.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),r.connect(a=>{if(i&&clearTimeout(i),r.on("error",n),a)this.log("client failed to connect",a),this._clients=this._clients.filter(o=>o!==r),s&&(a=new Error("Connection terminated due to connection timeout",{cause:a})),this._pulseQueue(),e.timedOut||e.callback(a,void 0,$N);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let o=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(r),this._idle.findIndex(c=>c.client===r)!==-1&&this._acquireClient(r,new to((c,u,p)=>p()),n,!1)},this.options.maxLifetimeSeconds*1e3);o.unref(),r.once("end",()=>clearTimeout(o))}return this._acquireClient(r,e,n,!0)}})}_acquireClient(e,r,n,i){i&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,n),e.removeListener("error",n),r.timedOut?i&&this.options.verify?this.options.verify(e,e.release):e.release():i&&this.options.verify?this.options.verify(e,s=>{if(s)return e.release(s),r.callback(s,void 0,$N);r.callback(void 0,e,e.release)}):r.callback(void 0,e,e.release)}_releaseOnce(e,r){let n=!1;return i=>{n&&iQ(),n=!0,this._release(e,r,i)}}_release(e,r,n){if(e.on("error",r),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",n,e),n||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this));if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this));let s;this.options.idleTimeoutMillis&&this._isAboveMin()&&(s=setTimeout(()=>{this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&s.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new wb(e,r,s)),this._pulseQueue()}query(e,r,n){if(typeof e=="function"){let s=vd(this.Promise,e);return setImmediate(function(){return s.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),s.result}typeof r=="function"&&(n=r,r=void 0);let i=vd(this.Promise,n);return n=i.callback,this.connect((s,a)=>{if(s)return n(s);let o=!1,l=c=>{o||(o=!0,a.release(c),n(c))};a.once("error",l),this.log("dispatching query");try{a.query(e,r,(c,u)=>{if(this.log("query dispatched"),a.removeListener("error",l),!o)return o=!0,a.release(c),c?n(c):n(void 0,u)})}catch(c){return a.release(c),n(c)}}),i.result}end(e){if(this.log("ending"),this.ending){let n=new Error("Called end on pool more than once");return e?e(n):this.Promise.reject(n)}this.ending=!0;let r=vd(this.Promise,e);return this._endCallback=r.callback,this._pulseQueue(),r.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,r)=>e+(this._expired.has(r)?1:0),0)}get totalCount(){return this._clients.length}};MN.exports=Sb});var UN=y((Hhe,BN)=>{"use strict";var FN=require("events").EventEmitter,aQ=require("util"),Eb=Ka(),ro=BN.exports=function(t,e,r){FN.call(this),t=Eb.normalizeQueryConfig(t,e,r),this.text=t.text,this.values=t.values,this.name=t.name,this.queryMode=t.queryMode,this.callback=t.callback,this.state="new",this._arrayMode=t.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(n){n==="row"&&(this._emitRowEvents=!0)}.bind(this))};aQ.inherits(ro,FN);var oQ={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};ro.prototype.handleError=function(t){let e=this.native.pq.resultErrorFields();if(e)for(let r in e){let n=oQ[r]||r;t[n]=e[r]}this.callback?this.callback(t):this.emit("error",t),this.state="error"};ro.prototype.then=function(t,e){return this._getPromise().then(t,e)};ro.prototype.catch=function(t){return this._getPromise().catch(t)};ro.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(t,e){this._once("end",t),this._once("error",e)}.bind(this)),this._promise)};ro.prototype.submit=function(t){this.state="running";let e=this;this.native=t.native,t.native.arrayMode=this._arrayMode;let r=function(n,i,s){if(t.native.arrayMode=!1,setImmediate(function(){e.emit("_done")}),n)return e.handleError(n);e._emitRowEvents&&(s.length>1?i.forEach((a,o)=>{a.forEach(l=>{e.emit("row",l,s[o])})}):i.forEach(function(a){e.emit("row",a,s)})),e.state="end",e.emit("end",s),e.callback&&e.callback(null,s)};if(process.domain&&(r=process.domain.bind(r)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));let n=(this.values||[]).map(Eb.prepareValue);if(t.namedQueries[this.name]){if(this.text&&t.namedQueries[this.name]!==this.text){let i=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return r(i)}return t.native.execute(this.name,n,r)}return t.native.prepare(this.name,this.text,n.length,function(i){return i?r(i):(t.namedQueries[e.name]=e.text,e.native.execute(e.name,n,r))})}else if(this.values){if(!Array.isArray(this.values)){let i=new Error("Query values must be an array");return r(i)}let n=this.values.map(Eb.prepareValue);t.native.query(this.text,n,r)}else this.queryMode==="extended"?t.native.query(this.text,[],r):t.native.query(this.text,r)}});var WN=y((Ghe,GN)=>{"use strict";var zN;try{zN=require("pg-native")}catch(t){throw t}var cQ=od(),VN=require("events").EventEmitter,lQ=require("util"),uQ=U0(),HN=UN(),Ir=GN.exports=function(t){VN.call(this),t=t||{},this._Promise=t.Promise||global.Promise,this._types=new cQ(t.types),this.native=new zN({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;let e=this.connectionParameters=new uQ(t);t.nativeConnectionString&&(e.nativeConnectionString=t.nativeConnectionString),this.user=e.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),this.database=e.database,this.host=e.host,this.port=e.port,this.namedQueries={}};Ir.Query=HN;lQ.inherits(Ir,VN);Ir.prototype._errorAllQueries=function(t){let e=r=>{process.nextTick(()=>{r.native=this.native,r.handleError(t)})};this._hasActiveQuery()&&(e(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(e),this._queryQueue.length=0};Ir.prototype._connect=function(t){let e=this;if(this._connecting){process.nextTick(()=>t(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(r,n){if(e.connectionParameters.nativeConnectionString&&(n=e.connectionParameters.nativeConnectionString),r)return t(r);e.native.connect(n,function(i){if(i)return e.native.end(),t(i);e._connected=!0,e.native.on("error",function(s){e._queryable=!1,e._errorAllQueries(s),e.emit("error",s)}),e.native.on("notification",function(s){e.emit("notification",{channel:s.relname,payload:s.extra})}),e.emit("connect"),e._pulseQueryQueue(!0),t()})})};Ir.prototype.connect=function(t){if(t){this._connect(t);return}return new this._Promise((e,r)=>{this._connect(n=>{n?r(n):e()})})};Ir.prototype.query=function(t,e,r){let n,i,s,a,o;if(t==null)throw new TypeError("Client was passed a null or undefined query");if(typeof t.submit=="function")s=t.query_timeout||this.connectionParameters.query_timeout,i=n=t,typeof e=="function"&&(t.callback=e);else if(s=t.query_timeout||this.connectionParameters.query_timeout,n=new HN(t,e,r),!n.callback){let l,c;i=new this._Promise((u,p)=>{l=u,c=p}).catch(u=>{throw Error.captureStackTrace(u),u}),n.callback=(u,p)=>u?c(u):l(p)}return s&&(o=n.callback,a=setTimeout(()=>{let l=new Error("Query read timeout");process.nextTick(()=>{n.handleError(l,this.connection)}),o(l),n.callback=()=>{};let c=this._queryQueue.indexOf(n);c>-1&&this._queryQueue.splice(c,1),this._pulseQueryQueue()},s),n.callback=(l,c)=>{clearTimeout(a),o(l,c)}),this._queryable?this._ending?(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client was closed and is not queryable"))}),i):(this._queryQueue.push(n),this._pulseQueryQueue(),i):(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client has encountered a connection error and is not queryable"))}),i)};Ir.prototype.end=function(t){let e=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,t));let r;return t||(r=new this._Promise(function(n,i){t=s=>s?i(s):n()})),this.native.end(function(){e._errorAllQueries(new Error("Connection terminated")),process.nextTick(()=>{e.emit("end"),t&&t()})}),r};Ir.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"};Ir.prototype._pulseQueryQueue=function(t){if(!this._connected||this._hasActiveQuery())return;let e=this._queryQueue.shift();if(!e){t||this.emit("drain");return}this._activeQuery=e,e.submit(this);let r=this;e.once("_done",function(){r._pulseQueryQueue()})};Ir.prototype.cancel=function(t){this._activeQuery===t?this.native.cancel(function(){}):this._queryQueue.indexOf(t)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(t),1)};Ir.prototype.ref=function(){};Ir.prototype.unref=function(){};Ir.prototype.setTypeParser=function(t,e,r){return this._types.setTypeParser(t,e,r)};Ir.prototype.getTypeParser=function(t,e){return this._types.getTypeParser(t,e)}});var Ib=y((Whe,QN)=>{"use strict";QN.exports=WN()});var _b=y((Khe,ul)=>{"use strict";var pQ=DN(),dQ=ol(),fQ=gb(),mQ=V0(),hQ=Ka(),gQ=qN(),vQ=od(),{DatabaseError:yQ}=fb(),{escapeIdentifier:bQ,escapeLiteral:xQ}=Ka(),wQ=t=>class extends gQ{constructor(r){super(r,t)}},kb=function(t){this.defaults=dQ,this.Client=t,this.Query=this.Client.Query,this.Pool=wQ(this.Client),this._pools=[],this.Connection=fQ,this.types=al(),this.DatabaseError=yQ,this.TypeOverrides=vQ,this.escapeIdentifier=bQ,this.escapeLiteral=xQ,this.Result=mQ,this.utils=hQ};typeof process.env.NODE_PG_FORCE_NATIVE<"u"?ul.exports=new kb(Ib()):(ul.exports=new kb(pQ),Object.defineProperty(ul.exports,"native",{configurable:!0,enumerable:!1,get(){let t=null;try{t=new kb(Ib())}catch(e){if(e.code!=="MODULE_NOT_FOUND")throw e}return Object.defineProperty(ul.exports,"native",{value:t}),t}}))});var Lr,Zhe,Xhe,Jhe,Yhe,ege,tge,rge,nge,ige,sge,age,dn,pl=L(()=>{Lr=ae(_b(),1),Zhe=Lr.default.Client,Xhe=Lr.default.Pool,Jhe=Lr.default.Connection,Yhe=Lr.default.types,ege=Lr.default.Query,tge=Lr.default.DatabaseError,rge=Lr.default.escapeIdentifier,nge=Lr.default.escapeLiteral,ige=Lr.default.Result,sge=Lr.default.TypeOverrides,age=Lr.default.defaults,dn=Lr.default});var KN,Ln,Ab,yd,Cb,Tb=L(()=>{pl();B();Kp();e0();Yy();ht();Vn();Le();({Pool:KN,types:Ln}=dn),Ab=class extends Vp{constructor(e,r,n,i,s,a,o,l){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=s,this._isResponseInArrayMode=o,this.customResultMapper=l,this.rawQueryConfig={name:a,text:r,types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}},this.queryConfig={name:a,text:r,rowMode:"array",types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}}}static[_]="NodePgPreparedQuery";rawQueryConfig;queryConfig;async execute(e={}){return Me.startActiveSpan("drizzle.execute",async()=>{let r=$g(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:s,queryConfig:a,joinsNotNullableMap:o,customResultMapper:l}=this;if(!n&&!l)return Me.startActiveSpan("drizzle.driver.execute",async u=>(u?.setAttributes({"drizzle.query.name":i.name,"drizzle.query.text":i.text,"drizzle.query.params":JSON.stringify(r)}),s.query(i,r)));let c=await Me.startActiveSpan("drizzle.driver.execute",u=>(u?.setAttributes({"drizzle.query.name":a.name,"drizzle.query.text":a.text,"drizzle.query.params":JSON.stringify(r)}),s.query(a,r)));return Me.startActiveSpan("drizzle.mapResponse",()=>l?l(c.rows):c.rows.map(u=>mT(n,u,o)))})}all(e={}){return Me.startActiveSpan("drizzle.execute",()=>{let r=$g(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),Me.startActiveSpan("drizzle.driver.execute",n=>(n?.setAttributes({"drizzle.query.name":this.rawQueryConfig.name,"drizzle.query.text":this.rawQueryConfig.text,"drizzle.query.params":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},yd=class t extends Hp{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new Qp}static[_]="NodePgSession";logger;prepareQuery(e,r,n,i,s){return new Ab(this.client,e.sql,e.params,this.logger,r,n,i,s)}async transaction(e,r){let n=this.client instanceof KN?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new Cb(this.dialect,n,this.schema);await i.execute(S`begin${r?S` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let s=await e(i);return await i.execute(S`commit`),s}catch(s){throw await i.execute(S`rollback`),s}finally{this.client instanceof KN&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},Cb=class t extends Gp{static[_]="NodePgTransaction";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(S.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(S.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(S.raw(`rollback to savepoint ${r}`)),i}}}});function dl(t,e={}){let r=new Oi({casing:e.casing}),n;e.logger===!0?n=new Wp:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let l=dP(e.schema,mP);i={fullSchema:e.schema,schema:l.tables,tableNamesMap:l.tableNamesMap}}let a=new Pb(t,r,{logger:n}).createSession(i),o=new Ob(r,a,i);return o.$client=t,o}function bd(...t){if(typeof t[0]=="string"){let e=new dn.Pool({connectionString:t[0]});return dl(e,t[1])}if(vT(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return dl(r,n);let i=typeof e=="string"?new dn.Pool({connectionString:e}):new dn.Pool(e);return dl(i,n)}return dl(t[0],t[1])}var Pb,Ob,ZN=L(()=>{pl();B();Kp();Bp();Op();Vc();Le();Tb();Pb=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[_]="NodePgDriver";createSession(e){return new yd(this.client,this.dialect,e,{logger:this.options.logger})}},Ob=class extends Da{static[_]="NodePgDatabase"};(t=>{function e(r){return dl({},r)}t.mock=e})(bd||(bd={}))});var XN=L(()=>{ZN();Tb()});var YN={};Mn(YN,{db:()=>g,pool:()=>JN});var SQ,JN,g,Os=L(()=>{"use strict";XN();pl();Ga();({Pool:SQ}=dn);if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");JN=new SQ({connectionString:process.env.DATABASE_URL}),g=bd(JN,{schema:_0})});var wd={};Mn(wd,{OLT_VENDORS:()=>LQ,buildOnuDiagnosisKey:()=>Rb,buildOnuSearchCommand:()=>i2,getDiagnosisFromAlarms:()=>FQ,hasSpecificDiagnosisCommand:()=>RQ,queryAllOltAlarms:()=>AQ,queryOltAlarm:()=>Ls,queryZabbixOpticalMetrics:()=>gl,searchOnuBySerial:()=>BQ,testOltConnection:()=>$b});function _Q(t,e){let r=t,n="";if(e.onuId){let i=e.onuId.match(/:(\d+)$/);i?n=i[1]:/^\d+$/.test(e.onuId)&&(n=e.onuId)}return r=r.replace(/\{serial\}/g,e.onuSearchString||""),r=r.replace(/\{slot\}/g,e.slotOlt?.toString()||""),r=r.replace(/\{port\}/g,e.portOlt?.toString()||""),r=r.replace(/\{onuId\}/g,n),r}function Rb(t,e){if(t.diagnosisKeyTemplate){let n=_Q(t.diagnosisKeyTemplate,e);if(n&&n.trim())return n}if((t.vendor||"").toLowerCase()==="datacom"){if(e.onuId){let n=e.onuId.match(/(\d+\/\d+\/\d+:\d+)/);if(n)return n[1].replace(":","/");if(/^\d+\/\d+\/\d+\/\d+$/.test(e.onuId))return e.onuId}if(e.slotOlt!=null&&e.portOlt!=null&&e.onuId){let n=e.onuId.match(/:(\d+)$/);if(n)return`1/${e.slotOlt}/${e.portOlt}/${n[1]}`;if(/^\d+$/.test(e.onuId))return`1/${e.slotOlt}/${e.portOlt}/${e.onuId}`}return console.log(`[OLT Diagnosis] Datacom: n\xE3o foi poss\xEDvel montar chave de diagn\xF3stico. onuId=${e.onuId}, slot=${e.slotOlt}, port=${e.portOlt}`),null}return e.onuSearchString?e.onuSearchString:e.onuId}function i2(t,e,r){if(t.searchOnuCommand){let i=t.searchOnuCommand;if(i=i.replace(/\{serial\}/g,e),r){let s="";if(r.onuId){let a=r.onuId.match(/:(\d+)$/);a?s=a[1]:/^\d+$/.test(r.onuId)&&(s=r.onuId)}i=i.replace(/\{slot\}/g,r.slotOlt?.toString()||""),i=i.replace(/\{port\}/g,r.portOlt?.toString()||""),i=i.replace(/\{onuId\}/g,s)}return i}let n=(t.vendor||"").toLowerCase();switch(n){case"datacom":return`show interface gpon onu | include "${e}"`;case"furukawa":return`sh onu serial ${e}`;case"huawei":return`display ont info by-sn ${e}`;case"zte":return`show gpon onu by sn ${e}`;case"nokia":return`show equipment ont interface | match ${e}`;default:return console.log(`[OLT Search] Vendor ${n} n\xE3o tem comando de busca configurado`),null}}async function EQ(t,e){console.log(`[OLT Zabbix] Consultando MySQL ${t.ipAddress}:${t.port} por serial ${e}...`);try{console.log("[OLT Zabbix] Conectando ao MySQL...");let r=await xd.default.createConnection({host:t.ipAddress,port:t.port,user:t.username,password:t.password,database:t.database||"db_django_olts",connectTimeout:3e4});console.log("[OLT Zabbix] Conex\xE3o estabelecida com sucesso");let n=`
0|link-monitor  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
0|link-monitor  | Error: DATABASE_URL must be set. Did you forget to provision a database?
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:92:31605
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:1:225
0|link-monitor  |     at Object.<anonymous> (/opt/link-monitor/dist/index.cjs:228:273)
0|link-monitor  |     at Module._compile (node:internal/modules/cjs/loader:1521:14)
0|link-monitor  |     at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
0|link-monitor  |     at Module.load (node:internal/modules/cjs/loader:1266:32)
0|link-monitor  |     at Module._load (node:internal/modules/cjs/loader:1091:12)
0|link-monitor  |     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
0|link-monitor  |     at node:internal/main/run_main_module:28:49
0|link-monitor  | Node.js v20.19.6
0|link-monitor  | > rest-express@1.0.0 start
0|link-monitor  | > NODE_ENV=production node dist/index.cjs
0|link-monitor  | /opt/link-monitor/dist/index.cjs:92
0|link-monitor  | `);ll.write(CN.format.apply(CN,e))}}Object.defineProperty(ai.exports,"isWin",{get:function(){return md},set:function(t){md=t}});ai.exports.warnTo=function(t){var e=ll;return ll=t,e};ai.exports.getFileName=function(t){var e=t||process.env,r=e.PGPASSFILE||(md?AN.join(e.APPDATA||"./","postgresql","pgpass.conf"):AN.join(e.HOME||"./",".pgpass"));return r};ai.exports.usePgPass=function(t,e){return Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")?!1:md?!0:(e=e||"<unkn>",GW(t.mode)?t.mode&(UW|zW)?(yb('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',e),!1):!0:(yb('WARNING: password file "%s" is not a plain file',e),!1))};var QW=ai.exports.match=function(t,e){return eo.slice(0,-1).reduce(function(r,n,i){return i==1&&Number(t[n]||BW)===Number(e[n])?r&&!0:r&&(e[n]==="*"||e[n]===t[n])},!0)};ai.exports.getPassword=function(t,e,r){var n,i=e.pipe(FW());function s(l){var c=KW(l);c&&ZW(c)&&QW(t,c)&&(n=c[WW],i.end())}var a=function(){e.destroy(),r(n)},o=function(l){e.destroy(),yb("WARNING: error on reading file: %s",l),r(void 0)};e.on("error",o),i.on("data",s).on("end",a).on("error",o)};var KW=ai.exports.parseLine=function(t){if(t.length<11||t.match(/^\s+#/))return null;for(var e="",r="",n=0,i=0,s=0,a={},o=!1,l=function(u,p,d){var f=t.substring(p,d);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(f=f.replace(/\\([:\\])/g,"$1")),a[eo[u]]=f},c=0;c<t.length-1;c+=1){if(e=t.charAt(c+1),r=t.charAt(c),o=n==vb-1,o){l(n,i);break}c>=0&&e==":"&&r!=="\\"&&(l(n,i,c+1),i=c+2,n+=1)}return a=Object.keys(a).length===vb?a:null,a},ZW=ai.exports.isValidEntry=function(t){for(var e={0:function(a){return a.length>0},1:function(a){return a==="*"?!0:(a=Number(a),isFinite(a)&&a>0&&a<9007199254740992&&Math.floor(a)===a)},2:function(a){return a.length>0},3:function(a){return a.length>0},4:function(a){return a.length>0}},r=0;r<eo.length;r+=1){var n=e[r],i=t[eo[r]]||"",s=n(i);if(!s)return!1}return!0}});var ON=y((Uhe,bb)=>{"use strict";var Bhe=require("path"),PN=require("fs"),hd=TN();bb.exports=function(t,e){var r=hd.getFileName();PN.stat(r,function(n,i){if(n||!hd.usePgPass(i,r))return e(void 0);var s=PN.createReadStream(r);hd.getPassword(t,s,e)})};bb.exports.warnTo=hd.warnTo});var DN=y((zhe,RN)=>{"use strict";var XW=require("events").EventEmitter,NN=Ka(),xb=JO(),JW=od(),YW=U0(),LN=pN(),eQ=ol(),tQ=gb(),rQ=q0(),gd=class extends XW{constructor(e){super(),this.connectionParameters=new YW(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;let r=e||{};this._Promise=r.Promise||global.Promise,this._types=new JW(r.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.enableChannelBinding=!!r.enableChannelBinding,this.connection=r.connection||new tQ({stream:r.stream,ssl:this.connectionParameters.ssl,keepAlive:r.keepAlive||!1,keepAliveInitialDelayMillis:r.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=r.binary||eQ.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=r.connectionTimeoutMillis||0}_errorAllQueries(e){let r=n=>{process.nextTick(()=>{n.handleError(e,this.connection)})};this.activeQuery&&(r(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(r),this.queryQueue.length=0}_connect(e){let r=this,n=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let i=new Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(i)});return}this._connecting=!0,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{n._ending=!0,n.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis),this.connectionTimeoutHandle.unref&&this.connectionTimeoutHandle.unref()),this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){r.ssl?n.requestSsl():n.startup(r.getStartupConf())}),n.on("sslconnect",function(){n.startup(r.getStartupConf())}),this._attachListeners(n),n.once("end",()=>{let i=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(i),this._ended=!0,this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(i):this._handleErrorEvent(i):this._connectionError||this._handleErrorEvent(i)),process.nextTick(()=>{this.emit("end")})})}connect(e){if(e){this._connect(e);return}return new this._Promise((r,n)=>{this._connect(i=>{i?n(i):r()})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let r=this.connection;if(typeof this.password=="function")this._Promise.resolve().then(()=>this.password()).then(n=>{if(n!==void 0){if(typeof n!="string"){r.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=n}else this.connectionParameters.password=this.password=null;e()}).catch(n=>{r.emit("error",n)});else if(this.password!==null)e();else try{ON()(this.connectionParameters,i=>{i!==void 0&&(this.connectionParameters.password=this.password=i),e()})}catch(n){this.emit("error",n)}}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(async()=>{try{let r=await rQ.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(r)}catch(r){this.emit("error",r)}})}_handleAuthSASL(e){this._checkPgPass(()=>{try{this.saslSession=xb.startSession(e.mechanisms,this.enableChannelBinding&&this.connection.stream),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(r){this.connection.emit("error",r)}})}async _handleAuthSASLContinue(e){try{await xb.continueSession(this.saslSession,this.password,e.data,this.enableChannelBinding&&this.connection.stream),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(r){this.connection.emit("error",r)}}_handleAuthSASLFinal(e){try{xb.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(r){this.connection.emit("error",r)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:r}=this;this.activeQuery=null,this.readyForQuery=!0,r&&r.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let r=this.activeQuery;if(!r){this._handleErrorEvent(e);return}this.activeQuery=null,r.handleError(e,this.connection)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){if(this.activeQuery==null){let r=new Error("Received unexpected commandComplete message from backend.");this._handleErrorEvent(r);return}this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(){if(this.activeQuery==null){let e=new Error("Received unexpected parseComplete message from backend.");this._handleErrorEvent(e);return}this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){let e=this.connectionParameters,r={user:e.user,database:e.database},n=e.application_name||e.fallback_application_name;return n&&(r.application_name=n),e.replication&&(r.replication=""+e.replication),e.statement_timeout&&(r.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(r.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(r.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(r.options=e.options),r}cancel(e,r){if(e.activeQuery===r){let n=this.connection;this.host&&this.host.indexOf("/")===0?n.connect(this.host+"/.s.PGSQL."+this.port):n.connect(this.port,this.host),n.on("connect",function(){n.cancel(e.processID,e.secretKey)})}else e.queryQueue.indexOf(r)!==-1&&e.queryQueue.splice(e.queryQueue.indexOf(r),1)}setTypeParser(e,r,n){return this._types.setTypeParser(e,r,n)}getTypeParser(e,r){return this._types.getTypeParser(e,r)}escapeIdentifier(e){return NN.escapeIdentifier(e)}escapeLiteral(e){return NN.escapeLiteral(e)}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&process.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,r,n){let i,s,a,o,l;if(e==null)throw new TypeError("Client was passed a null or undefined query");return typeof e.submit=="function"?(a=e.query_timeout||this.connectionParameters.query_timeout,s=i=e,typeof r=="function"&&(i.callback=i.callback||r)):(a=e.query_timeout||this.connectionParameters.query_timeout,i=new LN(e,r,n),i.callback||(s=new this._Promise((c,u)=>{i.callback=(p,d)=>p?u(p):c(d)}).catch(c=>{throw Error.captureStackTrace(c),c}))),a&&(l=i.callback,o=setTimeout(()=>{let c=new Error("Query read timeout");process.nextTick(()=>{i.handleError(c,this.connection)}),l(c),i.callback=()=>{};let u=this.queryQueue.indexOf(i);u>-1&&this.queryQueue.splice(u,1),this._pulseQueryQueue()},a),i.callback=(c,u)=>{clearTimeout(o),l(c,u)}),this.binary&&!i.binary&&(i.binary=!0),i._result&&!i._result._types&&(i._result._types=this._types),this._queryable?this._ending?(process.nextTick(()=>{i.handleError(new Error("Client was closed and is not queryable"),this.connection)}),s):(this.queryQueue.push(i),this._pulseQueryQueue(),s):(process.nextTick(()=>{i.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),s)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(e)e();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),e)this.connection.once("end",e);else return new this._Promise(r=>{this.connection.once("end",r)})}};gd.Query=LN;RN.exports=gd});var qN=y((Vhe,MN)=>{"use strict";var nQ=require("events").EventEmitter,$N=function(){},jN=(t,e)=>{let r=t.findIndex(e);return r===-1?void 0:t.splice(r,1)[0]},wb=class{constructor(e,r,n){this.client=e,this.idleListener=r,this.timeoutId=n}},to=class{constructor(e){this.callback=e}};function iQ(){throw new Error("Release called on client which has already been released to the pool.")}function vd(t,e){if(e)return{callback:e,result:void 0};let r,n,i=function(a,o){a?r(a):n(o)},s=new t(function(a,o){n=a,r=o}).catch(a=>{throw Error.captureStackTrace(a),a});return{callback:i,result:s}}function sQ(t,e){return function r(n){n.client=e,e.removeListener("error",r),e.on("error",()=>{t.log("additional client error after disconnection due to error",n)}),t._remove(e),t.emit("error",n,e)}}var Sb=class extends nQ{constructor(e,r){super(),this.options=Object.assign({},e),e!=null&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),e!=null&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||r||_b().Client,this.Promise=this.options.Promise||global.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(r=>{this._remove(r.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let r=this._idle.pop();clearTimeout(r.timeoutId);let n=r.client;n.ref&&n.ref();let i=r.idleListener;return this._acquireClient(n,e,i,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e,r){let n=jN(this._idle,s=>s.client===e);n!==void 0&&clearTimeout(n.timeoutId),this._clients=this._clients.filter(s=>s!==e);let i=this;e.end(()=>{i.emit("remove",e),typeof r=="function"&&r()})}connect(e){if(this.ending){let i=new Error("Cannot use a pool after calling end on the pool");return e?e(i):this.Promise.reject(i)}let r=vd(this.Promise,e),n=r.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new to(r.callback)),n;let i=(o,l,c)=>{clearTimeout(a),r.callback(o,l,c)},s=new to(i),a=setTimeout(()=>{jN(this._pendingQueue,o=>o.callback===i),s.timedOut=!0,r.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return a.unref&&a.unref(),this._pendingQueue.push(s),n}return this.newClient(new to(r.callback)),n}newClient(e){let r=new this.Client(this.options);this._clients.push(r);let n=sQ(this,r);this.log("checking client timeout");let i,s=!1;this.options.connectionTimeoutMillis&&(i=setTimeout(()=>{this.log("ending client due to timeout"),s=!0,r.connection?r.connection.stream.destroy():r.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),r.connect(a=>{if(i&&clearTimeout(i),r.on("error",n),a)this.log("client failed to connect",a),this._clients=this._clients.filter(o=>o!==r),s&&(a=new Error("Connection terminated due to connection timeout",{cause:a})),this._pulseQueue(),e.timedOut||e.callback(a,void 0,$N);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let o=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(r),this._idle.findIndex(c=>c.client===r)!==-1&&this._acquireClient(r,new to((c,u,p)=>p()),n,!1)},this.options.maxLifetimeSeconds*1e3);o.unref(),r.once("end",()=>clearTimeout(o))}return this._acquireClient(r,e,n,!0)}})}_acquireClient(e,r,n,i){i&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,n),e.removeListener("error",n),r.timedOut?i&&this.options.verify?this.options.verify(e,e.release):e.release():i&&this.options.verify?this.options.verify(e,s=>{if(s)return e.release(s),r.callback(s,void 0,$N);r.callback(void 0,e,e.release)}):r.callback(void 0,e,e.release)}_releaseOnce(e,r){let n=!1;return i=>{n&&iQ(),n=!0,this._release(e,r,i)}}_release(e,r,n){if(e.on("error",r),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",n,e),n||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this));if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this));let s;this.options.idleTimeoutMillis&&this._isAboveMin()&&(s=setTimeout(()=>{this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&s.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new wb(e,r,s)),this._pulseQueue()}query(e,r,n){if(typeof e=="function"){let s=vd(this.Promise,e);return setImmediate(function(){return s.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),s.result}typeof r=="function"&&(n=r,r=void 0);let i=vd(this.Promise,n);return n=i.callback,this.connect((s,a)=>{if(s)return n(s);let o=!1,l=c=>{o||(o=!0,a.release(c),n(c))};a.once("error",l),this.log("dispatching query");try{a.query(e,r,(c,u)=>{if(this.log("query dispatched"),a.removeListener("error",l),!o)return o=!0,a.release(c),c?n(c):n(void 0,u)})}catch(c){return a.release(c),n(c)}}),i.result}end(e){if(this.log("ending"),this.ending){let n=new Error("Called end on pool more than once");return e?e(n):this.Promise.reject(n)}this.ending=!0;let r=vd(this.Promise,e);return this._endCallback=r.callback,this._pulseQueue(),r.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,r)=>e+(this._expired.has(r)?1:0),0)}get totalCount(){return this._clients.length}};MN.exports=Sb});var UN=y((Hhe,BN)=>{"use strict";var FN=require("events").EventEmitter,aQ=require("util"),Eb=Ka(),ro=BN.exports=function(t,e,r){FN.call(this),t=Eb.normalizeQueryConfig(t,e,r),this.text=t.text,this.values=t.values,this.name=t.name,this.queryMode=t.queryMode,this.callback=t.callback,this.state="new",this._arrayMode=t.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(n){n==="row"&&(this._emitRowEvents=!0)}.bind(this))};aQ.inherits(ro,FN);var oQ={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};ro.prototype.handleError=function(t){let e=this.native.pq.resultErrorFields();if(e)for(let r in e){let n=oQ[r]||r;t[n]=e[r]}this.callback?this.callback(t):this.emit("error",t),this.state="error"};ro.prototype.then=function(t,e){return this._getPromise().then(t,e)};ro.prototype.catch=function(t){return this._getPromise().catch(t)};ro.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(t,e){this._once("end",t),this._once("error",e)}.bind(this)),this._promise)};ro.prototype.submit=function(t){this.state="running";let e=this;this.native=t.native,t.native.arrayMode=this._arrayMode;let r=function(n,i,s){if(t.native.arrayMode=!1,setImmediate(function(){e.emit("_done")}),n)return e.handleError(n);e._emitRowEvents&&(s.length>1?i.forEach((a,o)=>{a.forEach(l=>{e.emit("row",l,s[o])})}):i.forEach(function(a){e.emit("row",a,s)})),e.state="end",e.emit("end",s),e.callback&&e.callback(null,s)};if(process.domain&&(r=process.domain.bind(r)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));let n=(this.values||[]).map(Eb.prepareValue);if(t.namedQueries[this.name]){if(this.text&&t.namedQueries[this.name]!==this.text){let i=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return r(i)}return t.native.execute(this.name,n,r)}return t.native.prepare(this.name,this.text,n.length,function(i){return i?r(i):(t.namedQueries[e.name]=e.text,e.native.execute(e.name,n,r))})}else if(this.values){if(!Array.isArray(this.values)){let i=new Error("Query values must be an array");return r(i)}let n=this.values.map(Eb.prepareValue);t.native.query(this.text,n,r)}else this.queryMode==="extended"?t.native.query(this.text,[],r):t.native.query(this.text,r)}});var WN=y((Ghe,GN)=>{"use strict";var zN;try{zN=require("pg-native")}catch(t){throw t}var cQ=od(),VN=require("events").EventEmitter,lQ=require("util"),uQ=U0(),HN=UN(),Ir=GN.exports=function(t){VN.call(this),t=t||{},this._Promise=t.Promise||global.Promise,this._types=new cQ(t.types),this.native=new zN({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;let e=this.connectionParameters=new uQ(t);t.nativeConnectionString&&(e.nativeConnectionString=t.nativeConnectionString),this.user=e.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),this.database=e.database,this.host=e.host,this.port=e.port,this.namedQueries={}};Ir.Query=HN;lQ.inherits(Ir,VN);Ir.prototype._errorAllQueries=function(t){let e=r=>{process.nextTick(()=>{r.native=this.native,r.handleError(t)})};this._hasActiveQuery()&&(e(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(e),this._queryQueue.length=0};Ir.prototype._connect=function(t){let e=this;if(this._connecting){process.nextTick(()=>t(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(r,n){if(e.connectionParameters.nativeConnectionString&&(n=e.connectionParameters.nativeConnectionString),r)return t(r);e.native.connect(n,function(i){if(i)return e.native.end(),t(i);e._connected=!0,e.native.on("error",function(s){e._queryable=!1,e._errorAllQueries(s),e.emit("error",s)}),e.native.on("notification",function(s){e.emit("notification",{channel:s.relname,payload:s.extra})}),e.emit("connect"),e._pulseQueryQueue(!0),t()})})};Ir.prototype.connect=function(t){if(t){this._connect(t);return}return new this._Promise((e,r)=>{this._connect(n=>{n?r(n):e()})})};Ir.prototype.query=function(t,e,r){let n,i,s,a,o;if(t==null)throw new TypeError("Client was passed a null or undefined query");if(typeof t.submit=="function")s=t.query_timeout||this.connectionParameters.query_timeout,i=n=t,typeof e=="function"&&(t.callback=e);else if(s=t.query_timeout||this.connectionParameters.query_timeout,n=new HN(t,e,r),!n.callback){let l,c;i=new this._Promise((u,p)=>{l=u,c=p}).catch(u=>{throw Error.captureStackTrace(u),u}),n.callback=(u,p)=>u?c(u):l(p)}return s&&(o=n.callback,a=setTimeout(()=>{let l=new Error("Query read timeout");process.nextTick(()=>{n.handleError(l,this.connection)}),o(l),n.callback=()=>{};let c=this._queryQueue.indexOf(n);c>-1&&this._queryQueue.splice(c,1),this._pulseQueryQueue()},s),n.callback=(l,c)=>{clearTimeout(a),o(l,c)}),this._queryable?this._ending?(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client was closed and is not queryable"))}),i):(this._queryQueue.push(n),this._pulseQueryQueue(),i):(n.native=this.native,process.nextTick(()=>{n.handleError(new Error("Client has encountered a connection error and is not queryable"))}),i)};Ir.prototype.end=function(t){let e=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,t));let r;return t||(r=new this._Promise(function(n,i){t=s=>s?i(s):n()})),this.native.end(function(){e._errorAllQueries(new Error("Connection terminated")),process.nextTick(()=>{e.emit("end"),t&&t()})}),r};Ir.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"};Ir.prototype._pulseQueryQueue=function(t){if(!this._connected||this._hasActiveQuery())return;let e=this._queryQueue.shift();if(!e){t||this.emit("drain");return}this._activeQuery=e,e.submit(this);let r=this;e.once("_done",function(){r._pulseQueryQueue()})};Ir.prototype.cancel=function(t){this._activeQuery===t?this.native.cancel(function(){}):this._queryQueue.indexOf(t)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(t),1)};Ir.prototype.ref=function(){};Ir.prototype.unref=function(){};Ir.prototype.setTypeParser=function(t,e,r){return this._types.setTypeParser(t,e,r)};Ir.prototype.getTypeParser=function(t,e){return this._types.getTypeParser(t,e)}});var Ib=y((Whe,QN)=>{"use strict";QN.exports=WN()});var _b=y((Khe,ul)=>{"use strict";var pQ=DN(),dQ=ol(),fQ=gb(),mQ=V0(),hQ=Ka(),gQ=qN(),vQ=od(),{DatabaseError:yQ}=fb(),{escapeIdentifier:bQ,escapeLiteral:xQ}=Ka(),wQ=t=>class extends gQ{constructor(r){super(r,t)}},kb=function(t){this.defaults=dQ,this.Client=t,this.Query=this.Client.Query,this.Pool=wQ(this.Client),this._pools=[],this.Connection=fQ,this.types=al(),this.DatabaseError=yQ,this.TypeOverrides=vQ,this.escapeIdentifier=bQ,this.escapeLiteral=xQ,this.Result=mQ,this.utils=hQ};typeof process.env.NODE_PG_FORCE_NATIVE<"u"?ul.exports=new kb(Ib()):(ul.exports=new kb(pQ),Object.defineProperty(ul.exports,"native",{configurable:!0,enumerable:!1,get(){let t=null;try{t=new kb(Ib())}catch(e){if(e.code!=="MODULE_NOT_FOUND")throw e}return Object.defineProperty(ul.exports,"native",{value:t}),t}}))});var Lr,Zhe,Xhe,Jhe,Yhe,ege,tge,rge,nge,ige,sge,age,dn,pl=L(()=>{Lr=ae(_b(),1),Zhe=Lr.default.Client,Xhe=Lr.default.Pool,Jhe=Lr.default.Connection,Yhe=Lr.default.types,ege=Lr.default.Query,tge=Lr.default.DatabaseError,rge=Lr.default.escapeIdentifier,nge=Lr.default.escapeLiteral,ige=Lr.default.Result,sge=Lr.default.TypeOverrides,age=Lr.default.defaults,dn=Lr.default});var KN,Ln,Ab,yd,Cb,Tb=L(()=>{pl();B();Kp();e0();Yy();ht();Vn();Le();({Pool:KN,types:Ln}=dn),Ab=class extends Vp{constructor(e,r,n,i,s,a,o,l){super({sql:r,params:n}),this.client=e,this.params=n,this.logger=i,this.fields=s,this._isResponseInArrayMode=o,this.customResultMapper=l,this.rawQueryConfig={name:a,text:r,types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}},this.queryConfig={name:a,text:r,rowMode:"array",types:{getTypeParser:(c,u)=>c===Ln.builtins.TIMESTAMPTZ?p=>p:c===Ln.builtins.TIMESTAMP?p=>p:c===Ln.builtins.DATE?p=>p:c===Ln.builtins.INTERVAL?p=>p:Ln.getTypeParser(c,u)}}}static[_]="NodePgPreparedQuery";rawQueryConfig;queryConfig;async execute(e={}){return Me.startActiveSpan("drizzle.execute",async()=>{let r=$g(this.params,e);this.logger.logQuery(this.rawQueryConfig.text,r);let{fields:n,rawQueryConfig:i,client:s,queryConfig:a,joinsNotNullableMap:o,customResultMapper:l}=this;if(!n&&!l)return Me.startActiveSpan("drizzle.driver.execute",async u=>(u?.setAttributes({"drizzle.query.name":i.name,"drizzle.query.text":i.text,"drizzle.query.params":JSON.stringify(r)}),s.query(i,r)));let c=await Me.startActiveSpan("drizzle.driver.execute",u=>(u?.setAttributes({"drizzle.query.name":a.name,"drizzle.query.text":a.text,"drizzle.query.params":JSON.stringify(r)}),s.query(a,r)));return Me.startActiveSpan("drizzle.mapResponse",()=>l?l(c.rows):c.rows.map(u=>mT(n,u,o)))})}all(e={}){return Me.startActiveSpan("drizzle.execute",()=>{let r=$g(this.params,e);return this.logger.logQuery(this.rawQueryConfig.text,r),Me.startActiveSpan("drizzle.driver.execute",n=>(n?.setAttributes({"drizzle.query.name":this.rawQueryConfig.name,"drizzle.query.text":this.rawQueryConfig.text,"drizzle.query.params":JSON.stringify(r)}),this.client.query(this.rawQueryConfig,r).then(i=>i.rows)))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},yd=class t extends Hp{constructor(e,r,n,i={}){super(r),this.client=e,this.schema=n,this.options=i,this.logger=i.logger??new Qp}static[_]="NodePgSession";logger;prepareQuery(e,r,n,i,s){return new Ab(this.client,e.sql,e.params,this.logger,r,n,i,s)}async transaction(e,r){let n=this.client instanceof KN?new t(await this.client.connect(),this.dialect,this.schema,this.options):this,i=new Cb(this.dialect,n,this.schema);await i.execute(S`begin${r?S` ${i.getTransactionConfigSQL(r)}`:void 0}`);try{let s=await e(i);return await i.execute(S`commit`),s}catch(s){throw await i.execute(S`rollback`),s}finally{this.client instanceof KN&&n.client.release()}}async count(e){let r=await this.execute(e);return Number(r.rows[0].count)}},Cb=class t extends Gp{static[_]="NodePgTransaction";async transaction(e){let r=`sp${this.nestedIndex+1}`,n=new t(this.dialect,this.session,this.schema,this.nestedIndex+1);await n.execute(S.raw(`savepoint ${r}`));try{let i=await e(n);return await n.execute(S.raw(`release savepoint ${r}`)),i}catch(i){throw await n.execute(S.raw(`rollback to savepoint ${r}`)),i}}}});function dl(t,e={}){let r=new Oi({casing:e.casing}),n;e.logger===!0?n=new Wp:e.logger!==!1&&(n=e.logger);let i;if(e.schema){let l=dP(e.schema,mP);i={fullSchema:e.schema,schema:l.tables,tableNamesMap:l.tableNamesMap}}let a=new Pb(t,r,{logger:n}).createSession(i),o=new Ob(r,a,i);return o.$client=t,o}function bd(...t){if(typeof t[0]=="string"){let e=new dn.Pool({connectionString:t[0]});return dl(e,t[1])}if(vT(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return dl(r,n);let i=typeof e=="string"?new dn.Pool({connectionString:e}):new dn.Pool(e);return dl(i,n)}return dl(t[0],t[1])}var Pb,Ob,ZN=L(()=>{pl();B();Kp();Bp();Op();Vc();Le();Tb();Pb=class{constructor(e,r,n={}){this.client=e,this.dialect=r,this.options=n}static[_]="NodePgDriver";createSession(e){return new yd(this.client,this.dialect,e,{logger:this.options.logger})}},Ob=class extends Da{static[_]="NodePgDatabase"};(t=>{function e(r){return dl({},r)}t.mock=e})(bd||(bd={}))});var XN=L(()=>{ZN();Tb()});var YN={};Mn(YN,{db:()=>g,pool:()=>JN});var SQ,JN,g,Os=L(()=>{"use strict";XN();pl();Ga();({Pool:SQ}=dn);if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");JN=new SQ({connectionString:process.env.DATABASE_URL}),g=bd(JN,{schema:_0})});var wd={};Mn(wd,{OLT_VENDORS:()=>LQ,buildOnuDiagnosisKey:()=>Rb,buildOnuSearchCommand:()=>i2,getDiagnosisFromAlarms:()=>FQ,hasSpecificDiagnosisCommand:()=>RQ,queryAllOltAlarms:()=>AQ,queryOltAlarm:()=>Ls,queryZabbixOpticalMetrics:()=>gl,searchOnuBySerial:()=>BQ,testOltConnection:()=>$b});function _Q(t,e){let r=t,n="";if(e.onuId){let i=e.onuId.match(/:(\d+)$/);i?n=i[1]:/^\d+$/.test(e.onuId)&&(n=e.onuId)}return r=r.replace(/\{serial\}/g,e.onuSearchString||""),r=r.replace(/\{slot\}/g,e.slotOlt?.toString()||""),r=r.replace(/\{port\}/g,e.portOlt?.toString()||""),r=r.replace(/\{onuId\}/g,n),r}function Rb(t,e){if(t.diagnosisKeyTemplate){let n=_Q(t.diagnosisKeyTemplate,e);if(n&&n.trim())return n}if((t.vendor||"").toLowerCase()==="datacom"){if(e.onuId){let n=e.onuId.match(/(\d+\/\d+\/\d+:\d+)/);if(n)return n[1].replace(":","/");if(/^\d+\/\d+\/\d+\/\d+$/.test(e.onuId))return e.onuId}if(e.slotOlt!=null&&e.portOlt!=null&&e.onuId){let n=e.onuId.match(/:(\d+)$/);if(n)return`1/${e.slotOlt}/${e.portOlt}/${n[1]}`;if(/^\d+$/.test(e.onuId))return`1/${e.slotOlt}/${e.portOlt}/${e.onuId}`}return console.log(`[OLT Diagnosis] Datacom: n\xE3o foi poss\xEDvel montar chave de diagn\xF3stico. onuId=${e.onuId}, slot=${e.slotOlt}, port=${e.portOlt}`),null}return e.onuSearchString?e.onuSearchString:e.onuId}function i2(t,e,r){if(t.searchOnuCommand){let i=t.searchOnuCommand;if(i=i.replace(/\{serial\}/g,e),r){let s="";if(r.onuId){let a=r.onuId.match(/:(\d+)$/);a?s=a[1]:/^\d+$/.test(r.onuId)&&(s=r.onuId)}i=i.replace(/\{slot\}/g,r.slotOlt?.toString()||""),i=i.replace(/\{port\}/g,r.portOlt?.toString()||""),i=i.replace(/\{onuId\}/g,s)}return i}let n=(t.vendor||"").toLowerCase();switch(n){case"datacom":return`show interface gpon onu | include "${e}"`;case"furukawa":return`sh onu serial ${e}`;case"huawei":return`display ont info by-sn ${e}`;case"zte":return`show gpon onu by sn ${e}`;case"nokia":return`show equipment ont interface | match ${e}`;default:return console.log(`[OLT Search] Vendor ${n} n\xE3o tem comando de busca configurado`),null}}async function EQ(t,e){console.log(`[OLT Zabbix] Consultando MySQL ${t.ipAddress}:${t.port} por serial ${e}...`);try{console.log("[OLT Zabbix] Conectando ao MySQL...");let r=await xd.default.createConnection({host:t.ipAddress,port:t.port,user:t.username,password:t.password,database:t.database||"db_django_olts",connectTimeout:3e4});console.log("[OLT Zabbix] Conex\xE3o estabelecida com sucesso");let n=`
0|link-monitor  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
0|link-monitor  | Error: DATABASE_URL must be set. Did you forget to provision a database?
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:92:31605
0|link-monitor  |     at /opt/link-monitor/dist/index.cjs:1:225
0|link-monitor  |     at Object.<anonymous> (/opt/link-monitor/dist/index.cjs:228:273)
0|link-monitor  |     at Module._compile (node:internal/modules/cjs/loader:1521:14)
0|link-monitor  |     at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
0|link-monitor  |     at Module.load (node:internal/modules/cjs/loader:1266:32)
0|link-monitor  |     at Module._load (node:internal/modules/cjs/loader:1091:12)
0|link-monitor  |     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
0|link-monitor  |     at node:internal/main/run_main_module:28:49
0|link-monitor  | Node.js v20.19.6
0|link-monitor  | > rest-express@1.0.0 start
0|link-monitor  | > NODE_ENV=production node dist/index.cjs
