root@link-monitor:/opt/link-monitor# pm2 logs link-monitor --lines 50 | grep "Monitor"
0|link-mon | async deleteMibConfig(e){await b.delete(ut).where(_(ut.mibConfigId,e)),await b.delete(ur).where(_(ur.id,e))}async getHostMibConfigs(e){return await b.select().from(ut).where(_(ut.hostId,e))}async addHostMibConfig(e,r){let n=await this.getHost(e);if(!n)return;let i=await this.getMibConfig(r);!i||i.clientId!==n.clientId||(await b.select().from(ut).where(Ve(_(ut.hostId,e),_(ut.mibConfigId,r)))).length>0||await b.insert(ut).values({hostId:e,mibConfigId:r})}async removeHostMibConfig(e,r){await b.delete(ut).where(Ve(_(ut.hostId,e),_(ut.mibConfigId,r)))}async setHostMibConfigs(e,r){let n=await this.getHost(e);if(n){await b.delete(ut).where(_(ut.hostId,e));for(let i of r){let a=await this.getMibConfig(i);!a||a.clientId!==n.clientId||await b.insert(ut).values({hostId:e,mibConfigId:i})}}}async getEventTypes(){return await b.select().from(en)}async getEventType(e){let[r]=await b.select().from(en).where(_(en.id,e));return r||void 0}async getEventTypeByCode(e){let[r]=await b.select().from(en).where(_(en.code,e));return r||void 0}async createEventType(e){let[r]=await b.insert(en).values(e).returning();return r}async getClientEventSettings(e){return await b.select().from(ht).where(_(ht.clientId,e))}async getClientEventSetting(e,r){let[n]=await b.select().from(ht).where(Ve(_(ht.clientId,e),_(ht.eventTypeId,r)));return n||void 0}async upsertClientEventSetting(e){let r=await this.getClientEventSetting(e.clientId,e.eventTypeId);if(r)return await b.update(ht).set({...e,updatedAt:new Date}).where(_(ht.id,r.id)),{...r,...e};let[n]=await b.insert(ht).values(e).returning();return n}async deleteClientEventSetting(e,r){await b.delete(ht).where(Ve(_(ht.clientId,e),_(ht.eventTypeId,r)))}async resetClientEventSettings(e){await b.delete(ht).where(_(ht.clientId,e))}async initializeDefaultEventTypes(){if((await this.getEventTypes()).length>0)return;let r=[{code:"link_down",name:"Link Indispon\xEDvel",category:"connectivity",severity:"critical"},{code:"link_degraded",name:"Link Degradado",category:"connectivity",severity:"high"},{code:"high_latency",name:"Alta Lat\xEAncia",category:"performance",severity:"medium"},{code:"packet_loss",name:"Perda de Pacotes",category:"performance",severity:"high"},{code:"ddos_detected",name:"Ataque DDoS Detectado",category:"security",severity:"critical"},{code:"host_unreachable",name:"Host Inacess\xEDvel",category:"connectivity",severity:"high"},{code:"sla_breach",name:"Viola\xE7\xE3o de SLA",category:"sla",severity:"high"}];for(let n of r)await this.createEventType(n)}async initializeDefaultPermissions(){if((await this.getPermissions()).length>0)return;let r=[{code:"dashboard.view",name:"Visualizar Dashboard",category:"dashboard"},{code:"links.view",name:"Visualizar Links",category:"links"},{code:"links.manage",name:"Gerenciar Links",category:"links"},{code:"hosts.view",name:"Visualizar Hosts",category:"hosts"},{code:"hosts.manage",name:"Gerenciar Hosts",category:"hosts"},{code:"incidents.view",name:"Visualizar Incidentes",category:"incidents"},{code:"incidents.manage",name:"Gerenciar Incidentes",category:"incidents"},{code:"security.view",name:"Visualizar Seguran\xE7a",category:"security"},{code:"sla.view",name:"Visualizar SLA",category:"sla"},{code:"admin.view",name:"Visualizar Admin",category:"admin"},{code:"admin.manage",name:"Gerenciar Admin",category:"admin"}];for(let n of r)await b.insert(ya).values(n)}async initializeSuperAdmin(){(await b.select().from(Ae).where(_(Ae.email,"admin@marvitel.com.br"))).length>0||(await b.insert(Ae).values({email:"admin@marvitel.com.br",passwordHash:Eo("marvitel123"),name:"Super Admin Marvitel",role:"admin",clientId:null,isSuperAdmin:!0,isActive:!0}),console.log("Initialized super admin user"))}},k=new pv;var dv=class{config=null;constructor(){}configure(e){this.config=e}isConfigured(){return this.config!==null&&this.config.endpoint!==""&&this.config.user!==""&&this.config.password!==""}async apiRequest(e,r){if(!this.config)throw new Error("Wanguard n\xE3o configurado");let n=new URL(`${this.config.endpoint}/wanguard-api/v1${e}`);r&&Object.entries(r).forEach(([s,o])=>{n.searchParams.append(s,o)});let i=Buffer.from(`${this.config.user}:${this.config.password}`).toString("base64"),a=await fetch(n.toString(),{method:"GET",headers:{Authorization:`Basic ${i}`,"Content-Type":"application/json"}});if(!a.ok)throw new Error(`Wanguard API error: ${a.status} ${a.statusText}`);return a.json()}async getActiveAnomalies(){try{return await this.apiRequest("/anomalies",{Status:"Active"})}catch(e){return console.error("Erro ao buscar anomalias ativas do Wanguard:",e),[]}}async getHistoricalAnomalies(e){try{let r={Status:"Historical"};return e&&(r.StartTime=e.toISOString()),await this.apiRequest("/anomalies",r)}catch(r){return console.error("Erro ao buscar anomalias hist\xF3ricas do Wanguard:",r),[]}}async getAnomalyDetails(e){try{return await this.apiRequest(`/anomalies/${e}`)}catch(r){return console.error(`Erro ao buscar detalhes da anomalia ${e}:`,r),null}}mapAnomalyToEvent(e,r,n){let i={syn:"SYN Flood",udp:"UDP Flood",icmp:"ICMP Flood",dns:"DNS Amplification",ntp:"NTP Amplification",ssdp:"SSDP Amplification",memcached:"Memcached Amplification",chargen:"Chargen Amplification",http:"HTTP Flood",https:"HTTPS Flood",tcp:"TCP Flood",fragment:"Fragmentation Attack",slowloris:"Slowloris",rudy:"R.U.D.Y."},a=e.decoder?.toLowerCase()||"",s="Volumetric Attack";for(let[u,c]of Object.entries(i))if(a.includes(u)){s=c;break}let o={active:"mitigating",detected:"detected",mitigated:"mitigated",historical:"mitigated"};return{linkId:n,clientId:r,attackType:s,startTime:new Date(e.start_time),endTime:e.end_time?new Date(e.end_time):null,peakBandwidth:e.kbps/1e3,mitigationStatus:o[e.status?.toLowerCase()]||"detected",sourceIps:0,blockedPackets:0,wanguardAnomalyId:e.id,wanguardSensor:e.sensor,targetIp:e.ip,decoder:e.decoder}}async testConnection(){if(!this.config)return{success:!1,message:"Wanguard n\xE3o configurado"};try{return await this.apiRequest("/anomalies",{limit:"1"}),{success:!0,message:"Conex\xE3o com Wanguard estabelecida com sucesso"}}catch(e){return{success:!1,message:`Falha na conex\xE3o: ${e instanceof Error?e.message:"Erro desconhecido"}`}}}},rn=new dv;var mi=class{config=null;accessToken=null;tokenExpiresAt=null;constructor(){}configure(e){let r=e.apiUrl.trim();r.endsWith("/")&&(r=r.slice(0,-1)),r.match(/:(\d+)$/)&&(r=r.replace(/:(\d+)$/,"")),this.config={...e,apiUrl:r},this.accessToken=null,this.tokenExpiresAt=null}isConfigured(){return this.config!==null&&this.config.apiUrl!==""&&this.config.clientId!==""&&this.config.clientSecret!==""}async authenticate(){if(!this.config)throw new Error("Voalle n\xE3o configurado");if(this.accessToken&&this.tokenExpiresAt&&new Date<this.tokenExpiresAt)return this.accessToken;let e=`${this.config.apiUrl}:45700/connect/token`,r=new URLSearchParams({grant_type:"client_credentials",scope:"syngw",client_id:this.config.clientId,client_secret:this.config.clientSecret}),n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!n.ok){let a=await n.text();throw new Error(`Falha na autentica\xE7\xE3o Voalle: ${n.status} - ${a}`)}let i=await n.json();return this.accessToken=i.access_token,this.tokenExpiresAt=new Date(Date.now()+(i.expires_in-60)*1e3),this.accessToken}async apiRequest(e,r,n){if(!this.config)throw new Error("Voalle n\xE3o configurado");let i=await this.authenticate(),a=`${this.config.apiUrl}:45715/external/integrations/thirdparty${r}`,s={Authorization:`Bearer ${i}`,"Content-Type":"application/json"};this.config.synV1Token&&(s["syn-v1-token"]=this.config.synV1Token);let o=await fetch(a,{method:e,headers:s,body:n?JSON.stringify(n):void 0});if(!o.ok){let u=await o.text();throw new Error(`Voalle API error: ${o.status} - ${u}`)}return o.json()}async testConnection(){if(!this.config)return{success:!1,message:"Voalle n\xE3o configurado"};try{return await this.authenticate(),{success:!0,message:"Conex\xE3o com Voalle estabelecida com sucesso"}}catch(e){return{success:!1,message:`Falha na conex\xE3o: ${e instanceof Error?e.message:"Erro desconhecido"}`}}}async createProtocol(e,r,n,i){if(!this.config)return{success:!1,message:"Voalle n\xE3o configurado"};try{let a={falha_eletrica:"Falha El\xE9trica",rompimento_fibra:"Rompimento de Fibra",falha_equipamento:"Falha de Equipamento",indefinido:"Causa Indefinida"},s=`[Link Monitor] Incidente - ${n}`,o=`
0|link-mon | [Monitor] Sede Administrativa: latency=2.1ms, loss=0.0%, down=0.00Mbps, up=0.00Mbps, status=operational
0|link-mon | [Monitor] Central de Atendimento: latency=1.3ms, loss=0.0%, down=0.00Mbps, up=0.00Mbps, status=operational
0|link-monitor  | [Monitor] Central de Atendimento: latency=1.7ms, loss=0.0%, down=0.00Mbps, up=0.00Mbps, status=operational
0|link-monitor  | [Monitor] Sede Administrativa: latency=2.1ms, loss=0.0%, down=0.00Mbps, up=0.00Mbps, status=operational
